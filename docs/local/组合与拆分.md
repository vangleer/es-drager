# å¯æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬ç»„ä»¶ä¹‹ - å¤šå…ƒç´ ç»„åˆä¸æ‹†åˆ†åŠŸèƒ½

## ğŸŒˆä»‹ç»

åŸºäº vue3.x + CompositionAPI + typescript + vite çš„å¯æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬çš„ç»„ä»¶

*   æ‹–æ‹½&åŒºåŸŸæ‹–æ‹½
*   æ”¯æŒç¼©æ”¾
*   æ—‹è½¬
*   ç½‘æ ¼æ‹–æ‹½ç¼©æ”¾

[åœ¨çº¿ç¤ºä¾‹](https://vangleer.github.io/es-drager)

[æºç åœ°å€](https://github.com/vangleer/es-drager)

è¿™èŠ‚ä¸»è¦æ¥åˆ†äº«å¦‚ä½•ä½¿ç”¨es-dragerï¼Œæ ¹æ®ç°æœ‰åŠŸèƒ½å®ç°å¤šä¸ªå…ƒç´ ç»„åˆä¸æ‹†åˆ†åŠŸèƒ½

## es-dragerçš„æ›´æ–°

es-drager çš„1.xç‰ˆæœ¬æ”¯æŒç§»åŠ¨ç«¯å•¦

å¦å¤–æœ€è¿‘è¿˜åœ¨ä½¿ç”¨es-dragerå¼€å‘ä¸€ä¸ªä½ä»£ç ç¼–è¾‘å™¨ï¼ˆè¿˜æœªæˆå‹ï¼‰ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªes-dragerçš„ç»¼åˆä½¿ç”¨æ¡ˆä¾‹å§

## æœ¬ç« å†…å®¹

*   ä½¿ç”¨svgç»˜åˆ¶ç½‘æ ¼
*   å…ƒç´ ç»„åˆä¸æ‹†åˆ†

## ä½¿ç”¨svgç»˜åˆ¶ç½‘æ ¼

åœ¨å¼€å§‹è®²ç»„åˆä¹‹å‰ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨svgç”»ä¸€ä¸ªæŒ‡å®šå¤§å°çš„ç½‘æ ¼ã€‚å‰é¢çš„demoéƒ½æ˜¯ä½¿ç”¨cssçš„æ–¹å¼ï¼Œæ„Ÿè§‰è¿˜æ˜¯ä¸å¤ªçµæ´»ï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§

è¿™é‡Œç›´æ¥æŠ½ç¦»æˆäº†ä¸€ä¸ª vue ç»„ä»¶

```html
<template>
   <div class="grid-rect" :style="rectStyle">
    <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <pattern v-if="showSmall" id="smallGrid" :width="grid" :height="grid" patternUnits="userSpaceOnUse">
          <path :d="`M ${grid} 0 L 0 0 0 ${grid}`" fill="none" :stroke="color.grid" stroke-width="0.5"/>
        </pattern>
        <pattern id="grid" :width="bigGrid" :height="bigGrid" patternUnits="userSpaceOnUse">
          <rect v-if="showSmall" :width="bigGrid" :height="bigGrid" fill="url(#smallGrid)"/>
          <path :d="`M ${bigGrid} 0 L 0 0 0 ${bigGrid}`" fill="none" :stroke="color.bigGrid" stroke-width="1"/>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#grid)" />
    </svg>
   </div>
</template>

<script setup lang='ts'>
import { computed } from 'vue'
import { useAppStore } from '@/store'
const store = useAppStore()

const props = defineProps({
  grid: { // å°ç½‘æ ¼çš„å¤§å°
    type: Number,
    default: 10
  },
  gridCount: { // å°ç½‘æ ¼çš„æ•°é‡ï¼Œé»˜è®¤ä¸º5ä¸ª
    type: Number,
    default: 5
  },
  showSmall: { // æ˜¯å¦æ˜¾ç¤ºå°ç½‘æ ¼
    type: Boolean,
    default: true
  }
})

// è®¡ç®—å¤§ç½‘æ ¼çš„å¤§å°
const bigGrid = computed(() => props.grid * props.gridCount)

// å¤„ç†ç½‘ç«™çš®è‚¤ï¼Œå¯å¿½ç•¥
const color = computed(() => {
  const colors = [['#e4e7ed', '#ebeef5'], ['#414243', '#363637']]
  const [bigGrid, grid] = colors[store.isLight ? 0 : 1]
  return { bigGrid, grid }
})

const rectStyle = computed(() => ({ '--border-color': color.value.bigGrid }))
</script>

<style lang='scss' scoped>
.grid-rect {
  width: 100%;
  height: 100%;
  border-right: 1px solid var(--border-color);
  border-bottom: 1px solid var(--border-color);
}
</style>

```

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¸åŠ å±æ€§çš„è¯ï¼Œæ•´ä¸ªç½‘æ ¼ç»„ä»¶è¿˜æ˜¯æŒºç®€å•çš„

*   åœ¨`<defs>`æ ‡ç­¾ä¸­å®šä¹‰äº†ä¸¤ä¸ªå›¾æ¡ˆï¼ˆpatternï¼‰å…ƒç´ ã€‚`<pattern>`ç”¨äºåˆ›å»ºå¯é‡å¤ä½¿ç”¨çš„å›¾æ¡ˆã€‚è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªå›¾æ¡ˆï¼Œä¸€ä¸ªæ˜¯åä¸º"smallGrid"çš„å°ç½‘æ ¼å›¾æ¡ˆï¼Œå¦ä¸€ä¸ªæ˜¯åä¸º"grid"çš„å¤§ç½‘æ ¼å›¾æ¡ˆã€‚

*   å°ç½‘æ ¼çš„ id ä¸º smallGridï¼Œå®ƒçš„å¤§å°é»˜è®¤æ˜¯ grid=10

*   å¤§ç½‘æ ¼çš„ id ä¸º gridï¼Œé»˜è®¤å¤§å° grid\*gridCount=50ï¼Œç”±ä¸€ä¸ªçŸ©å½¢ï¼ˆ`<rect>`ï¼‰å’Œä¸€ä¸ªè·¯å¾„ï¼ˆ`<path>`ï¼‰ç»„æˆã€‚çŸ©å½¢ç”¨äºå¡«å……æ•´ä¸ªå›¾æ¡ˆåŒºåŸŸï¼Œå…¶å¡«å……æ ·å¼ï¼ˆfillï¼‰ä½¿ç”¨äº†åä¸º"smallGrid"çš„å°ç½‘æ ¼å›¾æ¡ˆã€‚è·¯å¾„ç”¨äºåˆ›å»ºå››æ¡è¾¹æ¡†çº¿ï¼Œä»èµ·ç‚¹(50, 0)åˆ°(0, 0)ï¼Œå†åˆ°(0, 50)ã€‚

*   æœ€åï¼Œé€šè¿‡`<rect>`å…ƒç´ åˆ›å»ºä¸€ä¸ªçŸ©å½¢ï¼Œå®ƒçš„å®½åº¦å’Œé«˜åº¦éƒ½è®¾ç½®ä¸º100%ï¼Œå¡«å……æ ·å¼ï¼ˆfillï¼‰ä½¿ç”¨äº†åä¸º"grid"çš„å¤§ç½‘æ ¼å›¾æ¡ˆã€‚

ä½¿ç”¨æ—¶ç›´æ¥åŒ…è£¹åœ¨ç”»å¸ƒå…ƒç´ é‡Œå³å¯ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ å…¥æŒ‡å®šç½‘æ ¼çš„å¤§å°

```html
<template>
  <div class="es-editor">
    <GridRect />
  </div>
</template>

<script setup lang='ts'>
import GridRect from '@/components/editor/GridRect.vue'
</script>

<style lang='scss' scoped>
.es-editor {
  position: relative;
  width: 800px;
  height: 600px;
}
</style>
```

![12.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/255cd4a92d364ccbb45f1caf8c1cf28b~tplv-k3u1fbpfcp-watermark.image?)

## å…ƒç´ ç»„åˆä¸æ‹†åˆ†

### é€‰ä¸­åŒºåŸŸ

ç»„åˆå‰ï¼Œæˆ‘ä»¬éœ€è¦é€‰ä¸­éœ€è¦ç»„åˆçš„å…ƒç´ ï¼Œç±»ä¼¼ä¸‹å›¾è¿™æ ·çš„æ•ˆæœ

![13.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e19bd51924b47199b94f123feae8df2~tplv-k3u1fbpfcp-watermark.image?)

#### å•ç‹¬æŠ½ç¦»åŒºåŸŸé€‰ä¸­ç»„ä»¶ Area

```html
<template>
  <div v-show="show" class="es-editor-area" :style="areaStyle"></div>
</template>

<script setup lang='ts'>
import { computed, ref } from 'vue'

const emit = defineEmits(['move', 'up'])

const show = ref(false)
const areaData = ref({
  width: 0,
  height: 0,
  top: 0,
  left: 0
})
const areaStyle = computed(()=> {
  const { width, height, top, left } = areaData.value
  return {
    width: width + 'px',
    height: height + 'px',
    top: top + 'px',
    left: left + 'px'
  }
})

function onMouseDown(e: MouseEvent) {
  show.value = true
  // é¼ æ ‡æŒ‰ä¸‹çš„ä½ç½®
  const { pageX: downX, pageY: downY } = e;
  const elRect = (e.target as HTMLElement)!.getBoundingClientRect()

  // é¼ æ ‡åœ¨ç¼–è¾‘å™¨ä¸­çš„åç§»é‡
  const offsetX = downX - elRect.left
  const offsetY = downY - elRect.top

  const onMouseMove = (e: MouseEvent) => {
    // ç§»åŠ¨çš„è·ç¦»
    const disX = e.pageX - downX
    const disY = e.pageY - downY

    // å¾—åˆ°é»˜è®¤çš„leftã€top
    let left = offsetX, top = offsetY
    // å®½é«˜å–é¼ æ ‡ç§»åŠ¨è·ç¦»çš„ç»å¯¹å€¼
    let width = Math.abs(disX), height = Math.abs(disY)

    // å¦‚æœå¾€å·¦ï¼Œå°†leftå‡å»å¢åŠ çš„å®½åº¦
    if (disX < 0) {
      left = offsetX - width
    }

    // å¦‚æœå¾€ä¸Šï¼Œå°†topå‡å»å¢åŠ çš„é«˜åº¦
    if (disY < 0) {
      top = offsetY - height
    }

    areaData.value = {
      width,
      height,
      left,
      top
    }

    emit('move', { ...areaData.value })
  }

  const onMouseUp = () => {
    document.removeEventListener('mousemove', onMouseMove)
    document.removeEventListener('mouseup', onMouseUp)

    show.value = false
    areaData.value = {
      width: 0,
      height: 0,
      top: 0,
      left: 0
    }

    emit('up', areaData.value)
  }
  document.addEventListener('mousemove', onMouseMove)
  document.addEventListener('mouseup', onMouseUp)
}

defineExpose({
  onMouseDown,
  areaData
})
</script>

```

> æ³¨æ„ï¼šç”±äºè¿™ä¸ªonMouseDownæ˜¯ç”»å¸ƒè§¦å‘æ—¶è°ƒç”¨çš„ï¼Œ å› æ­¤ `e.target` è·å–çš„æ˜¯ç”»å¸ƒå…ƒç´ 

1.  é¦–å…ˆï¼Œå°† show çš„å€¼è®¾ç½®ä¸º trueï¼Œä»¥æ˜¾ç¤ºé€‰ä¸­åŒºåŸŸï¼Œè·å–é¼ æ ‡æŒ‰ä¸‹çš„ä½ç½®ï¼šé€šè¿‡é¼ æ ‡äº‹ä»¶å¯¹è±¡ e è·å–é¼ æ ‡æŒ‰ä¸‹æ—¶çš„é¡µé¢ä¸Šçš„æ¨ªåæ ‡ downX å’Œçºµåæ ‡ downYã€‚

2.  è·å–ç”»å¸ƒçš„ä½ç½®ï¼Œä»è€Œè®¡ç®—é€‰ä¸­åŒºåŸŸçš„ç›¸å¯¹äºç”»å¸ƒçš„åç§»é‡

3.  åœ¨ onMouseMove å‡½æ•°ä¸­è®¡ç®—åŒºåŸŸçš„å¤§å°å’Œä½ç½®ï¼šé€šè¿‡é¼ æ ‡ç§»åŠ¨çš„è·ç¦» disX å’Œ disY è®¡ç®—åŒºåŸŸçš„å®½åº¦å’Œé«˜åº¦ï¼Œå¹¶æ ¹æ®ç§»åŠ¨çš„æ–¹å‘è°ƒæ•´ left å’Œ top çš„å€¼ï¼Œä»è€Œå®ç°ç¼–è¾‘åŒºåŸŸçš„è°ƒæ•´ã€‚

*   å®½åº¦å’Œé«˜åº¦ç›´æ¥å–å„è‡ªç§»åŠ¨è·ç¦»çš„ç»å¯¹å€¼
*   å¦‚æœ disX ä¸ºè´Ÿæ•°åˆ™leftè¦å‡å»å¢åŠ çš„å®½åº¦ï¼ŒdixYåŒç†

4.  æŠ¬èµ·é¼ æ ‡ onMouseUp ä¸­éšè—é€‰åŒºï¼Œé‡ç½®é€‰åŒºæ•°æ®

5.  åœ¨ onMouseMove å’Œ onMouseUp ä¸­éƒ½è§¦å‘äº†ç›¸åº”çš„äº‹ä»¶ moveå’Œupå¹¶ä¼ é€’é›¶é›¶é€‰åŒºçš„æ•°æ®ä¿¡æ¯

æœ‰äº†è¿™ä¸ªç»„ä»¶ï¼Œè¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ

å…ˆä¸Šä½¿ç”¨ä»£ç ï¼Œåé¢æœ‰è¯¦ç»†è§£é‡Š

```html
<template>
  <div class="es-container">
    <div class="es-tools">
      <el-button type="primary">ç»„åˆ</el-button>
      <el-button type="primary">æ‹†åˆ†</el-button>
    </div>
    <div class="es-editor" @mousedown="onEditorMouseDown">
      <Drager
        v-for="item in data.componentList"
        v-bind="item"
        @click.stop
        @mousedown.stop
      >
        <component :is="item.component!">{{ item.text }}</component>
      </Drager>

      <GridRect />
      <Area ref="areaRef" @move="onAreaMove" />
    </div>
  </div>
</template>

<script setup lang='ts'>
import { ref } from 'vue'
import GridRect from '@/components/editor/GridRect.vue'
import Drager, { DragData } from 'es-drager'
import Area from '@/components/editor/Area.vue'
import { ComponentType } from '@/components/types'

interface EditorState {
  componentList: ComponentType[]
}

const data = ref<EditorState>({
  componentList: [
    {
      component: 'div',
      text: 'div1',
      width: 100,
      height: 100,
      left: 100,
      top: 100
    },
    {
      component: 'div',
      text: 'div2',
      width: 100,
      height: 100,
      top: 200,
      left: 300
    }
  ]
})
const areaRef = ref()

// ç¼–è¾‘å™¨é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
function onEditorMouseDown(e: MouseEvent) {
  let flag = false
  data.value.componentList.forEach((item: ComponentType) => {
    // å¦‚æœæœ‰é€‰ä¸­çš„å…ƒç´ ï¼Œå–æ¶ˆé€‰ä¸­
    if (item.selected) {
      item.selected = false
      flag = true
    }
  })
  if (!flag) {
    areaRef.value.onMouseDown(e)
  }
}

function onAreaMove(areaData: DragData) {
  for (let i = 0; i < data.value.componentList.length; i++) {
    const item = data.value.componentList[i] as Required<ComponentType>
    // åŒ…å«left
    const containLeft = areaData.left < item.left && areaData.left + areaData.width > item.left + item.width
    // åŒ…å«top
    const containTop = areaData.top < item.top && areaData.top + areaData.height > item.top + item.height
    if (containLeft && containTop) {
      item.selected = true
    } else {
      item.selected = false
    }
  }
}
</script>

```

æ­¥éª¤è§£æ

1.  ç»™ç”»å¸ƒæ³¨å†Œmousedownäº‹ä»¶ `onEditorMouseDown`ï¼Œå¦‚æœå·²æœ‰é€‰ä¸­çš„å…ƒç´ å°†å…¶å…¨éƒ¨è®¾ç½®ä¸ºéé€‰çŠ¶æ€ï¼Œå¹¶ä¸”ä¸è§¦å‘è¿™ä¸ªåŒºåŸŸé€‰æ‹©äº‹ä»¶ï¼Œåªæœ‰ç”»å¸ƒä¸Šæ²¡æœ‰é€‰ä¸­çš„å…ƒç´ æ—¶è§¦å‘åŒºåŸŸçš„mousedown

2.  è°ƒç”¨åˆšåˆšå°è£… Area ç»„ä»¶çš„ onMouseDown æ–¹æ³•å¹¶ä¼ å…¥äº†äº‹ä»¶å¯¹è±¡ï¼Œå› æ­¤åœ¨åœ¨ Area ç»„ä»¶é‡Œçš„ onMouseDown çš„ `e.target` å…¶å®è·å–çš„æ˜¯ç”»å¸ƒå…ƒç´ 

3.  ç›‘å¬ Area ç»„ä»¶çš„ `move` äº‹ä»¶ `onAreaMove`ã€‚å½“é€‰åŒºåœ¨ Area ç»„ä»¶ä¸­ç§»åŠ¨æ—¶ï¼Œ`onAreaMove` ä¼šè¢«è§¦å‘ã€‚åœ¨è¯¥å‡½æ•°ä¸­ï¼Œæ ¹æ®é€‰åŒºçš„æ•°æ®å»åˆ¤æ–­æ˜¯å¦æœ‰å…ƒç´ åœ¨é€‰åŒºå†…ã€‚å¦‚æœæœ‰å…ƒç´ åœ¨é€‰åŒºå†…ï¼Œå°±å°†å®ƒä»¬è®¾ç½®ä¸ºé€‰ä¸­çŠ¶æ€ã€‚

4.  åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é€‰åŒºå†…çš„é€»è¾‘è¿˜æ˜¯æŒºå¥½ç†è§£çš„ã€‚å¯¹äºæ¯ä¸ªå…ƒç´ ï¼Œåˆ¤æ–­é€‰åŒºçš„ `left` æ˜¯å¦å°äºå…ƒç´ çš„ `left`ï¼Œä¸”é€‰åŒºçš„ `left + width` æ˜¯å¦å¤§äºå…ƒç´ çš„ `left + width`ã€‚ç±»ä¼¼åœ°ï¼Œå¯¹äº `top` ä¹Ÿè¿›è¡Œç±»ä¼¼çš„åˆ¤æ–­ã€‚åªæœ‰å½“å…ƒç´ çš„å·¦ä¸Šè§’å’Œå³ä¸‹è§’åŒæ—¶åœ¨é€‰åŒºå†…ï¼Œæ‰åˆ¤å®šè¯¥å…ƒç´ ä¸ºè¢«é€‰ä¸­çŠ¶æ€ã€‚

### ç§»åŠ¨é€‰ä¸­çš„å…ƒç´ 

ç§»åŠ¨å¤šä¸ªåŒºåŸŸé€‰ä¸­çš„å…ƒç´ ï¼Œç±»ä¼¼ä¸‹é¢çš„æ•ˆæœ

![14.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53727d7dabbf4c1da227798795d9c5dd~tplv-k3u1fbpfcp-watermark.image?)

è¦è®¡ç®—æ¯ä¸ªå…ƒç´ çš„ç§»åŠ¨è·ç¦»ï¼Œå°±éœ€è¦es-drageræä¾›çš„ä¸€äº›äº‹ä»¶äº†

```html
<Drager
  v-for="item, index in data.componentList"
  v-bind="item"
  @change="onChange($event, item)"
  @drag-start="onDragstart(index)"
  @drag="onDrag"
  @click.stop
  @mousedown.stop
>
  <component :is="item.component!">{{ item.text }}</component>
</Drager>
```

```typescript
const currentIndex = ref(-1)
const areaRef = ref()
// æ¯æ¬¡æ‹–æ‹½ç§»åŠ¨çš„è·ç¦»
const areaSelected = ref(false)
const extraDragData = ref({
  prevLeft: 0,
  prevTop: 0
})

function onDragstart(index: number) {
  if (!areaSelected.value) { // å¦‚æœæ˜¯åŒºåŸŸé€‰ä¸­çŠ¶æ€
    // å°†ä¸Šä¸€æ¬¡ç§»åŠ¨å…ƒç´ å˜ä¸ºéé€‰
    data.value.componentList.forEach((item: ComponentType) => item.selected = false)
  }
 
  const current = data.value.componentList[index]
  // é€‰ä¸­å½“å‰å…ƒç´ 
  current.selected = true
  // è®°å½•æŒ‰ä¸‹çš„æ•°æ®ï¼Œä¸ºäº†è®¡ç®—å¤šä¸ªé€‰ä¸­æ—¶ç§»åŠ¨çš„è·ç¦»
  extraDragData.value.prevLeft = current.left!
  extraDragData.value.prevTop = current.top!

  currentIndex.value = index
}

function onDrag(dragData: DragData) {
  const disX = dragData.left - extraDragData.value.prevLeft
  const disY = dragData.top - extraDragData.value.prevTop


  // å¦‚æœé€‰ä¸­äº†å¤šä¸ª
  data.value.componentList.forEach((item: ComponentType, index: number) => {
    if (item.selected && currentIndex.value !== index) {
      item.left! += disX
      item.top! += disY
    }
  })

  extraDragData.value.prevLeft = dragData.left
  extraDragData.value.prevTop = dragData.top
}

function onChange(dragData: DragData, item: ComponentType) {
  Object.keys(dragData).forEach((key) => {
    item[key as keyof DragData] = dragData[key as keyof DragData]
  })
}
```

1.  `change` äº‹ä»¶ï¼š`change` äº‹ä»¶ä¸»è¦ç”¨äºæ›´æ–°æœ€æ–°çš„æ‹–æ‹½æ•°æ®ï¼ˆdragDataï¼‰

2.  `drag-start` äº‹ä»¶ï¼š

*   æ£€æŸ¥æ˜¯å¦æ˜¯åŒºåŸŸé€‰æ‹©çŠ¶æ€ï¼ˆ`areaSelected.value`ï¼‰ï¼Œå¦‚æœä¸æ˜¯åŒºåŸŸé€‰æ‹©çŠ¶æ€ï¼Œåˆ™å°†æ‰€æœ‰é€‰ä¸­çš„å…ƒç´ çš„ `selected` å±æ€§è®¾ç½®ä¸º `false`ï¼Œå³å°†å®ƒä»¬è®¾ä¸ºéé€‰ä¸­çŠ¶æ€ã€‚
*   é€‰ä¸­å½“å‰å…ƒç´ ï¼ˆå³ `current`ï¼‰å¹¶è®°å½•å…¶åˆå§‹ `left` å’Œ `top` ä½ç½®åˆ° `extraDragData` ä¸­ï¼Œä»¥ä¾¿åç»­è®¡ç®—å¤šä¸ªé€‰ä¸­å…ƒç´ çš„ç§»åŠ¨è·ç¦»ã€‚

3.  `drag` äº‹ä»¶ï¼š

*   é€šè¿‡å½“å‰æ‹–æ‹½çš„ `dragData` å’Œ `extraDragData` ä¸­è®°å½•çš„åˆå§‹ä½ç½®ï¼Œè®¡ç®—å‡ºæ‹–æ‹½å…ƒç´ çš„ç§»åŠ¨è·ç¦» `disX` å’Œ `disY`ã€‚
*   å¾ªç¯éå†æ‰€æœ‰å…ƒç´ ï¼Œå¯¹äºé€‰ä¸­çš„å…ƒç´ ï¼ˆé™¤äº†å½“å‰æ‹–æ‹½å…ƒç´ ï¼‰ï¼Œæ›´æ–°å…¶ `left` å’Œ `top` ä½ç½®ï¼Œä»¥å®ç°å¤šé€‰å…ƒç´ çš„è”åŠ¨ç§»åŠ¨ã€‚
*   æ›´æ–° `extraDragData` ä¸­çš„ `prevLeft` å’Œ `prevTop`ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è®¡ç®—ç§»åŠ¨è·ç¦»ã€‚

ä¸Šé¢å¤šäº† areaSelected è®°å½•æ˜¯å¦æ˜¯åŒºåŸŸé€‰æ‹©çŠ¶æ€ï¼Œé‚£ä¹ˆåœ¨ä»€ä¹ˆæƒ…å†µå®ƒçš„å€¼æ‰æ˜¯trueå‘¢ï¼Ÿ

è¿™æ—¶æˆ‘ä»¬å°±è¦ç›‘å¬ Area ç»„ä»¶çš„ up äº‹ä»¶äº†

```html
<Area ref="areaRef" @move="onAreaMove" @up="onAreaUp" />
```

```typescript
// æ¾å¼€åŒºåŸŸé€‰æ‹©
function onAreaUp() {
  areaSelected.value = data.value.componentList.some((item: ComponentType) => item.selected)

  // å¦‚æœåŒºåŸŸæœ‰é€‰ä¸­å…ƒç´ 
  if (areaSelected.value) {
    setTimeout(() => {
      document.addEventListener('click', () => {
        areaSelected.value = false
      }, { once: true })
    })
  }
}
```

åªæœ‰åŒºåŸŸé€‰ä¸­äº†å…ƒç´ ï¼ŒareaSelectedæ‰èƒ½æ˜¯trueï¼Œç„¶åç‚¹å‡»å…¶å®ƒåŒºåŸŸæ˜¯è®¾ç½®ä¸ºfalse

### ç»„åˆä¸æ‹†åˆ†

![15.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d206438d21c4f0287752343b0fa21bf~tplv-k3u1fbpfcp-watermark.image?)

å®Œæˆä¸Šé¢çš„å·¥ä½œåï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å°†å¤šä¸ªå…ƒç´ ç»„åˆæˆä¸€ä¸ªï¼Œä¸ºäº†æ–¹ä¾¿æ¸²æŸ“æˆ‘ä»¬å…ˆå°è£…ä¸€ä¸ªGroupç»„ä»¶

#### Group ç»„ä»¶

è¿™ä¸ªç»„ä»¶çš„åŠŸèƒ½å°±æ˜¯å¾ªç¯æ˜¾ç¤ºæ‰€æœ‰ç»„åˆçš„å…ƒç´ 

```html
<template>
  <div class="es-group">
    <component
      v-for="item in list"
      :is="item.component!"
      v-bind="item.props"
      :style="{
        ...item.style,
        width: item.width + 'px',
        height: item.height + 'px',
        left: item.left + 'px',
        top: item.top + 'px',
        transform: `rotate(${item.angle || 0}deg)`,
        position: 'absolute'
      }"
    >
      {{ item.text }}
    </component>
  </div>
</template>

<script setup lang='ts'>
import { ComponentType } from '@/components/types'
import { PropType, computed } from 'vue'

const props = defineProps({
  elements: {
    type: Array as PropType<ComponentType[]>,
    default: () => []
  },
  data: {
    type: Object as PropType<ComponentType>,
    default: () => ({})
  }
})

const list = computed(() => {
  return props.elements.map(item => {
    return { ...item }
  })
})
</script>
```

*   éšåæˆ‘ä»¬å‡†å¤‡ä¸¤ä¸ªæŒ‰é’®ï¼Œåˆ†åˆ«æ³¨å†Œäº†makeGroupå’ŒcancelGroupç‚¹å‡»äº‹ä»¶

```html
<el-button type="primary" @click="makeGroup">ç»„åˆ</el-button>
<el-button type="primary" @click="cancelGroup">æ‹†åˆ†</el-button>
```

```typescript
// ç»„åˆå…ƒç´ 
function makeGroup() {
  const selectedItems = data.value.componentList.filter(item => item.selected)

  if (!selectedItems.length) return
  // è®¾ç¬¬ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ä¸ºæœ€å¤§å’Œæœ€å°
  let { left: minLeft, top: minTop } = selectedItems[0] as Required<ComponentType>
  let maxLeft = minLeft, maxTop = minTop

  Math.max(...selectedItems.map(item => item.left!))
  selectedItems.slice(1).forEach(item => {
    const { left, top, width, height } = item as Required<ComponentType>
    // æœ€å°left
    minLeft = Math.min(minLeft, left)
    // æœ€å¤§top
    maxLeft = Math.max(maxLeft, left + width)
   
    // æœ€å°top
    minTop = Math.min(minTop, top)
    // æœ€å¤§top
    maxTop = Math.max(maxTop, top + height)
  })

  selectedItems.forEach(item => {
    item.left = item.left! - minLeft
    item.top = item.top! - minTop
  })
  
  const dragData = {
    left: minLeft,
    top: minTop,
    width: maxLeft - minLeft, // å®½åº¦ = æœ€å¤§left - æœ€å°left
    height: maxTop - minTop, // é«˜åº¦ = æœ€å¤§top - æœ€å°top
  }
  const groupElement: ComponentType = {
    component: 'es-group',
    group: true,
    ...dragData,
    props: {
      elements: selectedItems
    }
  }

  const newElements = data.value.componentList.filter(item => !item.selected)
  
  data.value.componentList = [...newElements, groupElement]
}

// å–æ¶ˆç»„åˆ
function cancelGroup() {
  const current = data.value.componentList[currentIndex.value]
  if (!current || current.component !== 'es-group') {
    return
  }
  const items = current.props.elements as ComponentType[]

  const newElements = items.map(item => {
    return {
      ...item,
      selected: false,
      left: item.left! + current.left!,
      top: item.top! + current.top!,
      angle: (item.angle! || 0) + (current.angle! || 0),
    }
  })

  const list = data.value.componentList.filter(item => item !== current)

  data.value.componentList = [...list, ...newElements]
}
```

ä¸‹é¢åˆ†åˆ«è§£é‡Šè¿™ä¸¤ä¸ªå‡½æ•°

1.  ç»„åˆå…ƒç´  (`makeGroup` å‡½æ•°)ï¼š

    *   é¦–å…ˆï¼Œè·å–æ‰€æœ‰é€‰ä¸­çš„å…ƒç´  (`selectedElements`)ã€‚
    *   å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å…ƒç´ ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œç»„åˆæ“ä½œã€‚
    *   å¯¹äºé€‰ä¸­çš„å…ƒç´ ï¼Œéå†è®¡ç®—å®ƒä»¬çš„æœ€å° `left` å’Œ `top` å€¼ï¼Œä»¥åŠæœ€å¤§ `left` å’Œ `top` å€¼ï¼Œä»è€Œç¡®å®šç»„åˆåå…ƒç´ çš„ä½ç½®å’Œå°ºå¯¸ã€‚
    *   ç„¶åï¼Œéå†é€‰ä¸­çš„å…ƒç´ ï¼Œæ ¹æ®è®¡ç®—å¾—åˆ°çš„æœ€å° `left` å’Œ `top`ï¼Œæ›´æ–°å®ƒä»¬çš„ `left` å’Œ `top` å€¼ï¼Œä½¿å®ƒä»¬ç›¸å¯¹äºç»„åˆåå…ƒç´ çš„ä½ç½®å‘ç”Ÿåç§»ï¼Œä»è€Œå°†å®ƒä»¬å½’ç½®åˆ°ç»„åˆåå…ƒç´ çš„å†…éƒ¨ã€‚
    *   åˆ›å»ºä¸€ä¸ªåä¸º `groupElement` çš„æ–°å…ƒç´ ï¼Œä½œä¸ºç»„åˆåçš„å…ƒç´ ã€‚è¯¥å…ƒç´ çš„å±æ€§åŒ…æ‹¬ï¼š`component` è®¾ç½®ä¸º 'es-group'ï¼Œ`group` è®¾ç½®ä¸º `true`ï¼Œä»¥åŠé€šè¿‡è®¡ç®—å¾—åˆ°çš„ `dragData` ä¿¡æ¯å’Œé€‰ä¸­çš„å…ƒç´ åˆ—è¡¨ `selectedElements`ã€‚
    *   å°†ç»„åˆåçš„å…ƒç´  `groupElement` æ·»åŠ åˆ° `data.value.componentList` ä¸­ï¼ŒåŒæ—¶ä¿ç•™å…¶ä»–éé€‰ä¸­å…ƒç´ ã€‚

2.  å–æ¶ˆç»„åˆ (`cancelGroup` å‡½æ•°)ï¼š

    *   é¦–å…ˆï¼Œæ£€æŸ¥å½“å‰é€‰ä¸­çš„å…ƒç´ æ˜¯å¦ä¸ºä¸€ä¸ªç»„åˆå…ƒç´ ï¼ˆ`current.component === 'es-group'`ï¼‰ã€‚å¦‚æœä¸æ˜¯ç»„åˆå…ƒç´ ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œæ‹†åˆ†æ“ä½œã€‚
    *   è·å–ç»„åˆå…ƒç´  `current` çš„ `props.elements`ï¼Œè¯¥å±æ€§å­˜å‚¨äº†ç»„åˆå…ƒç´ å†…éƒ¨çš„æ‰€æœ‰å…ƒç´ åˆ—è¡¨ã€‚
    *   å¯¹äºç»„åˆå…ƒç´ å†…éƒ¨çš„æ¯ä¸ªå…ƒç´ ï¼Œè®¡ç®—å…¶æ–°çš„ `left` å’Œ `top` å€¼ï¼Œä½¿å®ƒä»¬ç›¸å¯¹äºç”»å¸ƒå‘ç”Ÿåç§»ï¼Œå¹¶è€ƒè™‘äº†ç»„åˆå…ƒç´ çš„ä½ç½®å’Œè§’åº¦ã€‚
    *   åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒç´ åˆ—è¡¨ `newElements`ï¼Œè¯¥åˆ—è¡¨åŒ…å«äº†æ‹†åˆ†åçš„æ‰€æœ‰å…ƒç´ ã€‚
    *   å°†ç»„åˆå…ƒç´  `current` ä» `data.value.componentList` ä¸­åˆ é™¤ï¼ŒåŒæ—¶å°†æ‹†åˆ†åçš„å…ƒç´ åˆ—è¡¨ `newElements` æ·»åŠ åˆ° `data.value.componentList` ä¸­ã€‚

## æœ€å

æœ¬èŠ‚åªæ˜¯å¯¹å¤šä¸ªå…ƒç´ çš„ç»„åˆä¸æ‹†åˆ†çš„ç®€å•å®ç°ï¼Œå¯¹äºç»„åˆåçš„æ—‹è½¬ä¸ç¼©æ”¾æˆ‘æƒ³åœ¨åé¢çš„æ–‡ç« ä¸­ä»‹ç»ã€‚

æœ€åæ¥çœ‹çœ‹åœ¨drawioä¸­å…ƒç´ ç»„åˆä¸æ‹†åˆ†çš„æ•ˆæœ

![16.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f74b977d7674166ab51ced7e8e9a9dc~tplv-k3u1fbpfcp-watermark.image?)

drawioåœ¨å®ç°ç»„åˆåç¼©æ”¾ä¼šæœ‰ä¸€ç‚¹å°é—®é¢˜ï¼Œå¤§å®¶çœ‹ä¸‹å›¾

![17.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4852844876944a89e6201a4a66a667c~tplv-k3u1fbpfcp-watermark.image?)

å½“ç„¶æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°½å¯èƒ½å®ç°ç†æƒ³çš„ç»„åˆåçš„ç¼©æ”¾ä¸æ—‹è½¬

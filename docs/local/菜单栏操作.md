# å¯æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬ç»„ä»¶ä¹‹ - èœå•æ“ä½œæ ã€jsonæ•°æ®å¯¼å…¥å¯¼å‡º

## ğŸŒˆä»‹ç»

åŸºäº vue3.x + CompositionAPI + typescript + vite çš„å¯æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬çš„ç»„ä»¶

*   æ‹–æ‹½&åŒºåŸŸæ‹–æ‹½
*   æ”¯æŒç¼©æ”¾
*   æ—‹è½¬
*   ç½‘æ ¼æ‹–æ‹½ç¼©æ”¾

[åœ¨çº¿ç¤ºä¾‹](https://vangleer.github.io/es-drager)

[æºç åœ°å€](https://github.com/vangleer/es-drager)

ä¸Šä¸€èŠ‚åˆ†äº«äº†å…ƒç´ çš„ç»„åˆä¸æ‹†åˆ†ï¼Œä»Šå¤©çš„ä¸»è¦ä»»åŠ¡æ˜¯å®Œæˆç¼–è¾‘å™¨çš„å³é”®èœå•æ“ä½œæ å’Œæ•°æ®å¯¼å…¥å¯¼å‡ºç­‰åŠŸèƒ½ã€‚

## å³é”®èœå•æ“ä½œæ 

**æœ€ç»ˆæ•ˆæœ**

![22.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a522bfd62c34fbca5bd5d0b83de0128~tplv-k3u1fbpfcp-watermark.image?)

å¸¸è§çš„æ“ä½œæœ‰åˆ é™¤ã€å¤åˆ¶ã€åˆ›å»ºå‰¯æœ¬ã€ç½®é¡¶ã€ç½®åº•ã€ç»„åˆã€å–æ¶ˆç»„åˆã€é”å®š/è§£é”ã€ä¸Šç§»ã€ä¸‹ç§»ç­‰

åœ¨å¼€å§‹è®²å…·ä½“åŠŸèƒ½å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ª\$contentmenuæ–¹æ³•ã€‚å½“åœ¨ç”»å¸ƒå³é”®æ—¶è°ƒç”¨æ˜¾ç¤ºèœå•

### ç¬¬ä¸€æ­¥å‡†å¤‡ç»„ä»¶æ¨¡æ¿

è¿™ä¸ªç»„ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®ä¼ å…¥çš„é…ç½®å¯¹è±¡åœ¨æŒ‡å®šä½ç½®å¼¹å‡ºä¸€ä¸ªå³é”®èœå•ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç‚¹å‡»èœå•é¡¹æ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚

```html
<template>
  <div>
    <div ref="triggerRef" class="es-trigger" :style="triggerStyle"></div>
    <div
      ref="menuRef"
      v-show="state.visible"
      class="es-contentmenu"
      :style="style"
      @click.stop
      @mousedown.stop
    >
      <ul v-if="state.option.items">
        <li v-for="item in state.option.items" @click="handleItemClick(item)">{{ item.label }}</li>
      </ul>
    </div>
  </div>
</template>

<script setup lang='ts'>
import { ref, computed, onMounted, reactive, onBeforeUnmount, PropType } from 'vue'
import { computePosition, flip, shift, offset } from '@floating-ui/dom'
import { MenuItem, MenuOption } from './index'
const props = defineProps({
  option: {
    type: Object as PropType<MenuOption>,
    default: () => ({})
  }
})
const triggerRef = ref()
const menuRef = ref()

const state = reactive({
  option: props.option,
  visible: false,
  top: 0,
  left: 0
})

// èœå•çš„ä½ç½®
const style = computed(() => ({ left: state.left + 'px', top: state.top + 'px' }))
// è§¦å‘å™¨çš„ä½ç½®
const triggerStyle = computed(() => ({ left: state.option.clientX + 'px', top: state.option.clientY + 'px' }))

// floating-ui ä¸­é—´ä»¶
const middleware = [shift(), flip(), offset(10)]

const open = (option: Record<string, any>) => {
  state.option = option
  state.visible = true
  // æ¯æ¬¡æ‰“å¼€è®¡ç®—æœ€æ–°ä½ç½®
  computePosition(triggerRef.value, menuRef.value, { middleware }).then(data => {
    state.left = data.x
    state.top = data.y
  })
}
const close = () => {
  state.visible = false
}

// ç‚¹å‡»èœå•é¡¹
const handleItemClick = (item: MenuItem) => {
  state.option.onClick && state.option.onClick(item)
  close()
}

onMounted(() => {
  document.addEventListener('mousedown', close)
})

onBeforeUnmount(() => {
  document.removeEventListener('mousedown', close)
})

defineExpose({
  open,
  close
})
</script>
```

**è§£æï¼š**

1.  é¦–å…ˆæˆ‘ä»¬è¦å‡†å¤‡ä¸¤ä¸ªå…ƒç´ ï¼Œè§¦å‘å™¨ï¼ˆtriggerï¼‰å’Œèœå•å®¹å™¨
2.  `style` å’Œ `triggerStyle` æ˜¯è®¡ç®—å±æ€§ï¼Œæ ¹æ®çŠ¶æ€å¯¹è±¡çš„å€¼è®¡ç®—å³é”®èœå•å’Œè§¦å‘å™¨çš„ä½ç½®
3.  æä¾›openå’Œcloseæ–¹æ³•ï¼Œæ¯æ¬¡è°ƒç”¨ open æ‰§è¡Œ [floating-ui](https://floating-ui.com/) çš„ computePosition å‡½æ•°ä¼ å…¥éœ€è¦çš„å‚æ•°

> ä¸Šé¢çš„ floating-ui ä¸æ˜¯å¿…é¡»é¡¹ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©æ˜¯å¦ä½¿ç”¨

è¿™é‡Œæœ‰ä¸€ç¯‡åŸºäº floating-ui å°è£…çš„ popper ç»„ä»¶ï¼Œæœ‰å…´è¶£çš„ä¼™ä¼´å¯ä»¥çœ‹çœ‹ [ä¸€èµ·æ¥å°è£…ä¸€ä¸ª popper/tooltip ç»„ä»¶å§](https://juejin.cn/post/7265566737386553359)

### å°è£…æ–¹æ³• \$contextmenu

```typescript
import { useEditorContainer } from '@/hooks'
import { VNode, createVNode, render } from 'vue'
import Menu from './Menu.vue'

export type ActionType = 'remove' | 'copy' | 'paste' | 'duplicate' | 'top' | 'bottom' | 'bottom' | 'group' | 'ungroup' | 'selectAll' | 'lock' | 'moveUp' | 'moveDown'

export type MenuItem = {
  label: string,
  action: ActionType
}

export type MenuOption = {
  clientX?: number
  clientY?: number
  items?: MenuItem[]
  onClick?: (item: MenuItem) => void
}

let vm: VNode | null = null
export function $contextmenu(option: MenuOption) {
  if (!vm) {
    const { container: globalContainer } = useEditorContainer()
    const container = document.createElement('div')
    vm = createVNode(Menu, { option })

    // å°†ç»„ä»¶æ¸²æŸ“æˆçœŸå®èŠ‚ç‚¹
    render(vm, container)

    globalContainer.appendChild(container.firstElementChild!)
  }

  const { open } = vm.component!.exposed!
  open(option)
}
```

*   useEditorContainer å®ç°å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯åˆ›å»ºä¸€ä¸ªå…¨å±€å®¹å™¨å¹¶æ·»åŠ åˆ°bodyä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŠ¨æ€å¼¹çª—ç»Ÿä¸€æ”¾åˆ°è¿™ä¸ªå®¹å™¨ä¸­

```typescript
let cachedContainer: HTMLElement
const selector = `es-editor-container-1996`

type EditorContainerType = {
  container: HTMLElement
  selector: string
}

export const useEditorContainer = (): EditorContainerType => {
  if (!cachedContainer && !document.querySelector(`#${selector}`)) {
    const container = document.createElement('div')
    container.id = selector
    cachedContainer = container
    document.body.appendChild(container)
  }

  return {
    container: cachedContainer,
    selector
  }
}
```

### è°ƒç”¨æ–¹å¼

```html
<div class="es-editor" @contextmenu.prevent="onEditorContextMenu"></div>
<script setup lang='ts'>
import { $contextmenu } from '@/components/common'
function onEditorContextMenu(e: MouseEvent) {
  const { clientX, clientY }  = e
  $contextmenu({
    clientX,
    clientY,
    items: [
      { action: 'remove', label: 'åˆ é™¤' },
      { action: 'copy', label: 'å¤åˆ¶' },
      { action: 'duplicate', label: 'åˆ›å»ºå‰¯æœ¬' },
      { action: 'top', label: 'ç½®é¡¶' },
      { action: 'bottom', label: 'ç½®åº•' },
      { action: 'moveUp', label: 'ä¸Šç§»ä¸€å±‚' },
      { action: 'moveDown', label: 'ä¸‹ç§»ä¸€å±‚' }
    ],
    onClick({ action }) {
      console.log(action)
    }
  })
}
</script>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![18.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/10743988a15a41549993a3b685d892b8~tplv-k3u1fbpfcp-watermark.image?)

å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸‹æ–¹çš„å¯è§†åŒºåŸŸæ˜¾ç¤ºä¸ä¸‹çš„æ—¶å€™å°±ä¼šæ˜¾ç¤ºåœ¨ä¸Šæ–¹ã€‚è¿™å°±æ˜¯floating-uiçš„æ•ˆæœ

### å…·ä½“actionså®ç°

```html
<template>
  <div class="es-container">
    <div
      ref="editorRef"
      class="es-editor"
      @contextmenu.prevent="onEditorContextMenu"
    >
      <Drager
        v-for="item in data.elements"
        v-bind="item"
        rotatable
        @contextmenu.stop="onContextmenu($event, item)"
        @click.stop
        @mousedown.stop
      >
        <component
          :is="item.component!"
          v-bind="item.props"
          :style="{
            ...item.style,
            width: '100%',
            height: '100%'
          }"
        >
          {{ item.text }}
        </component>
      </Drager>
      <GridRect />
    </div>
  </div>
</template>

<script setup lang='ts'>
import { ref } from 'vue'
import GridRect from '@/components/editor/GridRect.vue'
import Drager from 'es-drager'
import { EditorType } from '@/components/types'
import { useId } from '@/utils'
import { useActions } from '@/hooks'
const data = ref<EditorType>({
  elements: [{
    id: useId(),
    component: 'div',
    width: 100,
    height: 100,
    left: 100,
    top: 100,
    text: 'div1',
    style: { backgroundColor: '#fff2cc', border: '2px solid #d6b656' }
  },
  {
    id: useId(),
    component: 'div',
    width: 100,
    height: 100,
    left: 300,
    top: 150,
    text: 'div2',
    style: {backgroundColor: '#f8cecc', border: '2px solid #b85450'}
  }]
})
const editorRef = ref<HTMLElement | null>(null)
const {
  onEditorContextMenu,
  onContextmenu
} = useActions(data, editorRef)
</script>

<style lang='scss' scoped>
.es-container {
  width: 800px;
  height: 600px;
  position: absolute;
  left: 50%;
  top: 40%;
  transform: translate(-50%, -50%);
  .es-editor {
    position: relative;
    width: 800px;
    height: 600px;
  }
}
</style>
```

æ¨¡æ¿ä¸­ä½¿ç”¨äº† `useActions` é’©å­ï¼Œæ¥æ”¶ `data` å’Œç”»å¸ƒçš„refï¼Œè¿”å› `onEditorContextMenu`ï¼ˆç”»å¸ƒå³é”®ï¼‰ å’Œ `onContextmenu`ï¼ˆå…ƒç´ å³é”®ï¼‰ã€‚æ³¨æ„å…ƒç´ å³é”®è¦é˜»æ­¢å†’æ³¡

çœ‹çœ‹ `useActions` çš„å…·ä½“å®ç°

```typescript
import { $contextmenu, ActionType, MenuItem } from '@/components/common'
import { ComponentType, EditorType } from '@/components/types'
import { cancelGroup, deepCopy, makeGroup, useId } from '@/utils'
import { computed, Ref } from 'vue'
type ActionMethods = {
  [key in ActionType]?: (element: ComponentType, ...args: any[]) => void
}
export function useActions(
  data: Ref<EditorType>,
  editorRef: Ref<HTMLElement | null>
) {
  const editorRect = computed(() => {
    return editorRef.value?.getBoundingClientRect() || {} as DOMRect
  })
  // å½“å‰å³é”®å…ƒç´ 
  let currentMenudownElement: ComponentType | null = null
  // å¤åˆ¶å…ƒç´ 
  let copySnapshot: ComponentType | null = null

  // è·å–æŒ‡å®šå…ƒç´ çš„ç´¢å¼•
  const getIndex = (element: ComponentType | null) => {
    if (!element) return -1
    return data.value.elements.findIndex(item => item.id === element.id)
  }

  // äº¤æ¢ä¸¤ä¸ªå…ƒç´ 
  const swap = (i: number, j: number) => {
    [data.value.elements[i], data.value.elements[j]] = [data.value.elements[j], data.value.elements[i]]
  }
  
  // æ·»åŠ å…ƒç´ 
  const addElement = (element: ComponentType | null) => {
    if (!element) return
    // æ‹·è´ä¸€ä»½
    const newElement = deepCopy(element)
    // ä¿®æ”¹id
    newElement.id = useId()
    data.value.elements.push(newElement)
  }
  const actions: ActionMethods = {
    remove() { // åˆ é™¤
      const index = getIndex(currentMenudownElement)
      if (index > -1) data.value.elements.splice(index, 1)
    },
    cut(element) { // å‰ªåˆ‡
      copySnapshot = element
      actions.remove!(element)
    },
    copy(element) { // æ‹·è´
      copySnapshot = element
    },
    duplicate(element) { // åˆ›å»ºå‰¯æœ¬
      const newElement = deepCopy(element)
      // åç§»leftå’Œtopé¿å…é‡å 
      newElement.left += 10
      newElement.top += 10
      addElement(newElement)
    },
    top(element) {
      // è·å–å½“å‰å…ƒç´ ç´¢å¼•
      const index = getIndex(element)
      // å°†è¯¥ç´¢å¼•çš„å…ƒç´ åˆ é™¤
      const [topElement] = data.value.elements.splice(index, 1)
      // æ·»åŠ åˆ°æœ«å°¾
      data.value.elements.push(topElement)
    },
    bottom(element) {
      // è·å–å½“å‰å…ƒç´ ç´¢å¼•
      const index = getIndex(element)
      // å°†è¯¥ç´¢å¼•çš„å…ƒç´ åˆ é™¤
      const [topElement] = data.value.elements.splice(index, 1)
      // æ·»åŠ åˆ°å¼€å¤´
      data.value.elements.unshift(topElement)
    },
    group() { // ç»„åˆ
      data.value.elements = makeGroup(data.value.elements, editorRect.value)
    },
    ungroup() { // æ‹†åˆ†
      data.value.elements = cancelGroup(data.value.elements, editorRect.value)
    },
    paste(_, clientX: number, clientY: number){ // ç²˜è´´
      if (!copySnapshot) return
      const element = deepCopy(copySnapshot)
      // è®¡ç®—ç²˜è´´ä½ç½®
      element.left = clientX - editorRect.value!.left
      element.top = clientY - editorRect.value!.top
  
      addElement(element)
    },
    selectAll() { // å…¨é€‰
      data.value.elements.forEach(item => item.selected = true)
    },
    lock(element) { // é”å®š/è§£é”
      const index = getIndex(element)
      data.value.elements[index].disabled = !data.value.elements[index].disabled
    },
    moveUp(element) { // ä¸Šç§»
      // è·å–å½“å‰å…ƒç´ ç´¢å¼•
      const index = getIndex(element)
      // ä¸èƒ½è¶…è¿‡è¾¹ç•Œ
      if (index >= data.value.elements.length - 1) {
        return 
      }

      swap(index, index + 1)
    },
    moveDown(element) { // ä¸‹ç§»
      // è·å–å½“å‰å…ƒç´ ç´¢å¼•
      const index = getIndex(element)
      // ä¸èƒ½è¶…è¿‡è¾¹ç•Œ
      if (index <= 0) {
        return 
      }

      swap(index, index - 1)
    }
  }

  // å…ƒç´ å³é”®èœå•
  const onContextmenu = (e: MouseEvent, item: ComponentType) => {
    e.preventDefault()
    const { clientX, clientY }  = e
    currentMenudownElement = deepCopy(item)
    
    const selectedElements = data.value.elements.filter(item => item.selected)
    const actionItems: MenuItem[] = [
      { action: 'remove', label: 'åˆ é™¤' },
      { action: 'cut', label: 'å‰ªåˆ‡' },
      { action: 'copy', label: 'å¤åˆ¶' },
      { action: 'duplicate', label: 'åˆ›å»ºå‰¯æœ¬' },
      { action: 'top', label: 'ç½®é¡¶' },
      { action: 'bottom', label: 'ç½®åº•' },
      { action: 'moveUp', label: 'ä¸Šç§»ä¸€å±‚' },
      { action: 'moveDown', label: 'ä¸‹ç§»ä¸€å±‚' },
    ]
    if (!item.group && selectedElements.length > 1) {
      // å¦‚æœä¸æ˜¯ç»„åˆå…ƒç´ å¹¶ä¸”æœ‰å¤šä¸ªé€‰ä¸­å…ƒç´ ï¼Œåˆ™æ˜¾ç¤ºç»„åˆæ“ä½œ
      actionItems.push({ action: 'group', label: 'ç»„åˆ' })
    } else {
      // æ˜¾ç¤ºå–æ¶ˆç»„åˆæ“ä½œ
      item.group && actionItems.push({ action: 'ungroup', label: 'å–æ¶ˆç»„åˆ' })
    }

    const isLocked = currentMenudownElement!.disabled
    const lockAction: MenuItem = { action: 'lock', label: 'é”å®š / è§£é”' }
    if (!isLocked) {
      actionItems.push(lockAction)
    }
    $contextmenu({
      clientX,
      clientY,
      items: !isLocked ? actionItems : [lockAction], // å¦‚æœæ˜¯é”å®šå…ƒç´ åªæ˜¾ç¤ºè§£é”æ“ä½œ
      onClick: ({ action }) => {
        if (actions[action]) {
          actions[action]!(currentMenudownElement!)
        }
      }
    })
  }

  // ç”»å¸ƒå³é”®èœå•
  const onEditorContextMenu = (e: MouseEvent) => {
    const { clientX, clientY }  = e
    $contextmenu({
      clientX,
      clientY,
      items: [
        { action: 'paste', label: 'åœ¨è¿™ç²˜è´´' },
        { action: 'selectAll', label: 'å…¨é€‰' },
      ],
      onClick({ action }) {
        if (action === 'paste') {
          actions.paste!(currentMenudownElement!, clientX, clientY)
        } else {
          actions[action] && actions[action]!(currentMenudownElement!)
        }
      }
    })
  }

  return {
    onContextmenu,
    onEditorContextMenu
  }
}
```

ç”±äºæ³¨é‡Šå¾ˆè¯¦ç»†ï¼Œä»£ç ä¹Ÿä¸å¤æ‚ï¼Œè¿™é‡Œå°±ç®€å•è¯´ä¸€ä¸‹ï¼š

*   `currentMenudownElement`: å­˜å‚¨å½“å‰å³é”®ç‚¹å‡»çš„å…ƒç´ ã€‚`copySnapshot`: å­˜å‚¨å¤åˆ¶çš„å…ƒç´ çš„å¿«ç…§ã€‚

*   æ‰€æœ‰æ“ä½œæ–¹æ³•ç»Ÿä¸€æ”¾åœ¨ actions å¯¹è±¡ä¸­ï¼Œé‡Œé¢çš„æ–¹æ³•ä¹Ÿéƒ½æ˜¯å¸¸è§çš„æ•°ç»„æ“ä½œ

*   `onContextmenu(e, item)`: å¤„ç†å…ƒç´ çš„å³é”®èœå•

    1.  æ¯æ¬¡å³é”®ä¿å­˜å½“å‰å…ƒç´ 
    2.  åˆ›å»ºé»˜è®¤ `actionItems`
    3.  åˆ¤æ–­æ˜¯å¦æ˜¯ç»„åˆå…ƒç´ ï¼Œå¦‚æœæœ‰å¤šä¸ªå…ƒç´ é€‰ä¸­æ˜¾ç¤ºç»„åˆï¼Œå¦‚æœæ˜¯ç»„åˆå…ƒç´ æ˜¾ç¤ºæ‹†åˆ†
    4.  åˆ¤æ–­å…ƒç´ æ˜¯å¦é”å®šï¼Œéé”å®šæ·»åŠ åˆ° `actionItems` ä¸­ï¼Œå¦åˆ™åªæ˜¾ç¤ºé”å®š/è§£é”æ“ä½œ
    5.  å½“ç‚¹å‡»èœå•é¡¹çš„æ—¶å€™è§¦å‘ `onClick`ï¼Œæ ¹æ® `action` è°ƒç”¨å¯¹åº”çš„æ–¹æ³•å³å¯
    6.  ç»„åˆä¸æ‹†åˆ†çš„å…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒå‰ä¸€ç¯‡æ–‡ç« 

*   `onEditorContextMenu(e)`: å¤„ç†ç”»å¸ƒçš„å³é”®èœå•ï¼Œæä¾›ç²˜è´´å’Œå…¨é€‰æ“ä½œã€‚

ä»€ä¹ˆã€‚ã€‚ã€‚è¿˜æœ‰é”®ç›˜äº‹ä»¶ï¼Œæœ‰äº†ä¸Šé¢çš„ `actions`ï¼Œé”®ç›˜äº‹ä»¶å°±...

è¿˜æ˜¯å†™å†™å§ï¼(â—Ë‡âˆ€Ë‡â—)

### é”®ç›˜äº‹ä»¶

è¿˜æ˜¯åœ¨ useActions è¿™ä¸ª hook é‡Œ

*   å®šä¹‰é”®ç›˜æ˜ å°„è¡¨

```typescript
// é”®ç›˜æ˜ å°„è¡¨
const keyboardMap = {
  ['ctrl+x']: 'cut',
  ['ctrl+c']: 'copy',
  ['ctrl+v']: 'paste',
  ['Delete']: 'remove',
  ['ctrl+a']: 'selectAll',
  ['ctrl+d']: 'duplicate'
}
```

*   æ·»åŠ äº‹ä»¶ç›‘å¬

```typescript
// ç›‘å¬é”®ç›˜äº‹ä»¶
const onKeydown = (e: KeyboardEvent) => {
  const { ctrlKey, key } = e
  // æ‹¼å‡‘æŒ‰ä¸‹çš„é”®
  const keyArr = []
  if (ctrlKey) keyArr.push('ctrl')
  keyArr.push(key)
  const keyStr = keyArr.join('+')
  // è·å–æ“ä½œ
  const action = (keyboardMap as any)[keyStr]! as ActionType
  // å¦‚æœactionsä¸­æœ‰å…·ä½“çš„æ“ä½œåˆ™æ‰§è¡Œ
  if (actions[action]) {
    e.preventDefault()
    // æ‰¾åˆ°å½“å‰é€‰ä¸­çš„å…ƒç´ 
    currentMenudownElement = data.value.elements.find(item => item.selected) || null
    actions[action]!(currentMenudownElement!)
  }
}

onMounted(() => {
  window.addEventListener('keydown', onKeydown)
})

onBeforeMount(() => {
  window.removeEventListener('keydown', onKeydown)
})
```

**è§£æï¼š**

1.  å‡†å¤‡ `keyboardMap` é”®ç›˜æ˜ å°„è¡¨ï¼ˆè¿™é‡Œåªæœ‰4ä¸ªï¼‰ï¼Œå€¼éœ€è¦ä¸ `actions` çš„æ–¹æ³•å¯¹åº”ï¼Œå¯ä»¥æ›´å¤š
2.  `onKeydown` ä¸­è·å–åˆ°æŒ‰ä¸‹çš„é”®/ç»„åˆï¼Œæ‹¼æ¥æˆè§„å®šçš„æ ¼å¼
3.  åˆ¤æ–­æ˜¯å¦ `actions` ä¸­æœ‰å¯¹åº”çš„æ–¹æ³•ï¼Œæœ‰åˆ™æ‰§è¡Œ
4.  æ³¨æ„ï¼šåœ¨å³é”®çš„æ—¶å€™æˆ‘ä»¬èƒ½çŸ¥é“æ˜¯å“ªä¸ªå…ƒç´ ï¼Œä½†åœ¨é”®ç›˜äº‹ä»¶é‡Œï¼Œåªèƒ½æŸ¥æ‰¾å½“å‰é€‰ä¸­çš„å…ƒç´ 

## jsonå¯¼å…¥å¯¼å‡º/æ’å…¥å›¾ç‰‡

å¯¼å…¥å¯¼å‡ºå’Œ `$contextmenu` ä¸€ä¸ªå¥—è·¯ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡æ–¹æ³•è°ƒç”¨ï¼Œä¾‹å¦‚ `$dialog({})` æˆ–è€… `$upload({})` çš„æ–¹å¼

### å¯¼å‡º

![19.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a7d12061f524af1b17264865f4aeb9c~tplv-k3u1fbpfcp-watermark.image?)

### Dialog æ¨¡æ¿

```html
<template>
  <ElDialog
    v-model="state.visible"
    v-bind="state.option"
    draggable
  >
    <div id="esEditor"></div>

    <template #footer>
      <ElButton @click="close">å–æ¶ˆ</ElButton>
      <ElButton type="primary" @click="handleConfirm">ä¿å­˜ç¼–è¾‘</ElButton>
      <ElButton type="primary" @click="handleExport">å¯¼å‡ºJSON</ElButton>
    </template>
  </ElDialog>
</template>

<script setup lang='ts'>
import { ElButton, ElDialog, dayjs} from 'element-plus'
import { nextTick, reactive } from 'vue'
import ace from 'ace-builds'
import 'ace-builds/src-min-noconflict/theme-one_dark'
import 'ace-builds/src-min-noconflict/mode-json5'
const props = defineProps({
  option: {
    type: Object,
    default: () => ({})
  }
})

const state = reactive({
  option: props.option,
  visible: false
})
let editor: ace.Ace.Editor

const open = (option: Record<string, any>) => {
  state.option = option
  state.visible = true

  nextTick(() => {
    editor = ace.edit('esEditor', {
      maxLines: 34,
      minLines: 34,
      fontSize: 14,
      theme: 'ace/theme/one_dark',
      mode: 'ace/mode/json5',
      tabSize: 4,
      readOnly: false
    })

    editor.setValue(JSON.stringify(JSON.parse(state.option.content), null, 4))
  })
}
// å…³é—­å¼¹çª—
const close = () => {
  state.visible = false
}

const handleConfirm = () => {
  const { confirm } = state.option
  confirm && confirm(editor && editor.getValue())
}

// ç‚¹å‡»å¯¼å‡ºjson
const handleExport = () => {
  if (!editor) return
  // åˆ›å»ºaæ ‡ç­¾
  const link = document.createElement('a')
  // ç”Ÿæˆæ–‡ä»¶åç§°
  const filename = dayjs().format('YYYY-MM-DD') + '-es-drager.json'
  link.download = filename
  // åˆ›å»ºblob
  const blob = new Blob([editor.getValue()])
  // åˆ›å»ºä¸´æ—¶url
  const href = URL.createObjectURL(blob)
  link.href = href
  // è°ƒç”¨click
  link.click()
  // é”€æ¯
  URL.revokeObjectURL(href)
}

defineExpose({
  open,
  close
})
</script>

```

`ace-editor` çš„å…·ä½“ä½¿ç”¨è¯·å‚è€ƒå®˜ç½‘ï¼Œå…¶å®ƒçš„éƒ½æ˜¯å¸¸è§„æ“ä½œ

1.  `handleConfirm`ï¼šç‚¹å‡»ç¡®è®¤è°ƒç”¨ `confirm` å›è°ƒå¹¶æŠŠæœ€æ–°æ•°æ®ä¼ é€’è¿‡å»
2.  `handleExport`ï¼šä½¿ç”¨aæ ‡ç­¾çš„æ–¹å¼ï¼Œä½ ä»¬æ¯”æˆ‘ç†Ÿ
3.  `open` æ–¹æ³•ä¸­ç”±äºé¡µé¢ä¸Šè¿˜æ²¡æœ‰idä¸º `esEditor` è¿™ä¸ªå…ƒç´ ï¼Œå› æ­¤åœ¨ `nextTick` é‡Œåˆ›å»ºçš„ `editor`

#### \$dialog æ–¹æ³•

```typescript
import { useEditorContainer } from '@/hooks'
import { VNode, createVNode, render } from 'vue'
import Dialog from './Dialog.vue'


let vm: VNode | null = null
export function $dialog(option: Object) {
  if (!vm) {
    // æ‰‹åŠ¨æŒ‚è½½ç»„ä»¶
    const { container: globalContainer } = useEditorContainer()
    const container = document.createElement('div')
    vm = createVNode(Dialog, { option })

    // å°†ç»„ä»¶æ¸²æŸ“æˆçœŸå®èŠ‚ç‚¹
    render(vm, container)

    globalContainer.appendChild(container.firstElementChild!)
  }

  const { open } = vm.component!.exposed!
  open(option)
}
```

### å¯¼å…¥json&æ’å…¥å›¾ç‰‡ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰

![20.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/daa972ea9ef2437897471ccd37bcbd1f~tplv-k3u1fbpfcp-watermark.image?)

#### å‡†å¤‡ä¸Šä¼ æ¨¡æ¿ upload.vue

```html
<template>
  <input ref="inpurRef" type="file" :accept="state.option?.accept" class="es-upload" @change="handleChange">
</template>

<script setup lang='ts'>
import { ref, onMounted, reactive, PropType } from 'vue'
import { UploadOption } from './index'
const acceptMap = {
  json: '.json',
  image: 'image/*'
}
const props = defineProps({
  option: {
    type: Object as PropType<UploadOption>,
    required: true
  }
})
const state = {
  option: props.option
}
const inpurRef = ref()

const open = (option: UploadOption) => {
  state.option = option
  let accept = (acceptMap as any)[option.resultType]
  if (option.accept) {
    accept = option.accept
  }
  inpurRef.value.setAttribute('accept', accept)
  inpurRef.value.click()
}

const handleChange = async (e: Event) => {
  if (!state.option || !state.option.onChange) return

  const { resultType, onChange } = state.option
  let result: any = e
  const file: File = (e.target as any).files[0]
  // å¦‚æœæ˜¯jsonæˆ–textä½¿ç”¨readAsTextè¯»å–
  if (['json', 'text'].includes(resultType)) {
    result = await readFile(file)
  } else if (resultType === 'image') {
    // æŒ‰ç…§base64è¯»å–
    result = await readFile(file, resultType)
  }

  // è°ƒç”¨onChangeå›è°ƒå¹¶æŠŠæ•°æ®ä¼ é€’è¿‡å»
  onChange(result)
  inpurRef.value.value = ''
}


/**
 * è¯»å–æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹
 */
const readFile = (file: File, type: string = 'text') => {
  return new Promise((resolve) => {
    const reader = new FileReader()
    reader.addEventListener('load', (e) => {
      const result = e.target!.result || '{}'
      resolve(result)
    })

    if (type === 'text') {
      reader.readAsText(file)
    } else {
      reader.readAsDataURL(file)
    }
  })
}

onMounted(() => {
  open(props.option)
})

defineExpose({
  open
})
</script>

<style lang='scss' scoped>
.es-upload {
  display: none;
}
</style>

```

1.  æ¯æ¬¡è°ƒç”¨ `open` æ–¹æ³•è‡ªåŠ¨è§¦å‘ `input` çš„ç‚¹å‡»äº‹ä»¶æ‰“å¼€æ–‡ä»¶é€‰æ‹©æ¡†
2.  `change` äº‹ä»¶ä¸­æ ¹æ®ä¼ é€’çš„ç±»å‹å¤„ç†æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸å¤„ç†ã€‚å¤„ç†å®Œæ¯•åè°ƒç”¨ `onChange` å›è°ƒæŠŠå¤„ç†åçš„æ•°æ®ä¼ é€’è¿‡å»

#### \$upload æ–¹æ³•

```typescript
import { useEditorContainer } from '@/hooks'
import { VNode, createVNode, render } from 'vue'
import Upload from './Upload.vue'
type ResultType = 'text' | 'json' | 'image' | 'custom'
export type UploadOption = {
  resultType: ResultType
  accept?: string
  onChange?: (e: any) => void
}
let vm: VNode | null = null
export function $upload(option: UploadOption) {
  if (!vm) {
    // æ‰‹åŠ¨æŒ‚è½½ç»„ä»¶
    const { container: globalContainer } = useEditorContainer()
    const container = document.createElement('div')
    vm = createVNode(Upload, { option })

    // å°†ç»„ä»¶æ¸²æŸ“æˆçœŸå®èŠ‚ç‚¹
    render(vm, container)

    globalContainer.appendChild(container.firstElementChild!)
  } else {
    // ç¬¬ä¸€æ¬¡ç»„ä»¶æŒ‚è½½ä¼šæ‰“å¼€ï¼Œåé¢è°ƒç”¨openæ‰“å¼€æ–‡ä»¶é€‰æ‹©æ¡†
    const { open } = vm.component!.exposed!
    open(option)
  }
}

```

å’Œä¸Šé¢ä¸€æ ·çš„å¥—è·¯ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼

### ä½¿ç”¨

```typescript
const tools: ToolType[] = [
  { label: 'å¯¼å‡º', handler: () => {
    $dialog({
      title: 'å¯¼å‡º',
      content: JSON.stringify(data.value),
      confirm(text: string) {
        data.value = JSON.parse(text)
      }
    })
  }},
  { label: 'å¯¼å…¥', handler: () => {
    $upload({
      resultType: 'json',
      onChange(text: string) {
        data.value = JSON.parse(text)
      }
    })
  }},
  { label: 'æ’å…¥å›¾ç‰‡', handler: () => {
    $upload({
      resultType: 'image',
      onChange(e: string) {
        const newElement: ComponentType = {
          id: useId(),
          component: 'img',
          props: { src: e, width: 160, onLoad(e: Event) {
            // å›¾ç‰‡åŠ è½½å®Œæ¯•ï¼Œå¾—åˆ°åŸå§‹å®½é«˜
            const { naturalHeight, naturalWidth } = e.target as any
            const cur = data.value.elements.find(item => item.id === newElement.id)!

            cur.width = naturalWidth
            cur.height = naturalHeight
          }}
        }

        data.value.elements.push(newElement)
      }
    })
  }}
]
```

```html
<el-button v-for="item in tools" type="primary" @click="item.handler">{{ item.label }}</el-button>
```

1.  å¯¼å…¥å’Œå¯¼å‡ºå¤„ç†å¾ˆç®€å•ï¼Œç›´æ¥èµ‹å€¼æœ€æ–°æ•°æ®å³å¯
2.  æ’å…¥å›¾ç‰‡éœ€è¦å•ç‹¬å¤„ç†ï¼Œéœ€è¦ç­‰åˆ°å›¾ç‰‡åŠ è½½å®Œæ¯•åè·å–åˆ°å›¾ç‰‡åŸå§‹å®½é«˜

**æ’å…¥å›¾ç‰‡æ•ˆæœ**

![21.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1c516c864b24ba697efbbfdabe2c8ea~tplv-k3u1fbpfcp-watermark.image?)

## æœ€å

æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ç¼–è¾‘å™¨é‡Œå¸¸è§çš„å³é”®èœå•æ“ä½œæ ã€å¯¼å…¥å¯¼å‡ºã€æ’å…¥å›¾ç‰‡ç­‰åŠŸèƒ½ã€‚ä¸ºäº†æ–¹ä¾¿è°ƒç”¨ï¼Œè¿™å‡ ä¸ªåŠŸèƒ½éƒ½å°è£…æˆæ–¹æ³•è°ƒç”¨çš„æ–¹å¼ã€‚ç›¸ä¿¡å¤§å®¶åº”è¯¥ä¹Ÿç†Ÿæ‚‰è¿™ç§å°è£…æ–¹å¼äº†å§

æŸ¥çœ‹å®Œæ•´ä»£ç è¯·æ»‘åˆ°é¡¶éƒ¨æœ‰ `github` é“¾æ¥åœ°å€å’Œåœ¨çº¿ç¤ºä¾‹

*   ç›¸å…³æ–‡ç« 

[å¯æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬ç»„ä»¶å®ç°ç»†èŠ‚](https://juejin.cn/post/7225152932675993655)

[ç½‘æ ¼æ•ˆæœåŠä½¿ç”¨æ–¹æ³•](https://juejin.cn/post/7239895206081806373)

[è¾…åŠ©çº¿å’Œæ’¤é”€å›é€€](https://juejin.cn/post/7254812719349383225)

[å…ƒç´ ç»„åˆä¸æ‹†åˆ†](https://juejin.cn/post/7258337246024843319)

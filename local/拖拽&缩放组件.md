# es-drager æ‹–æ‹½ç»„ä»¶

## ğŸŒˆä»‹ç»

åŸºäº vue3.x + CompositionAPI + typescript + vite çš„å¯æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬çš„ç»„ä»¶

- æ‹–æ‹½&åŒºåŸŸæ‹–æ‹½
- æ”¯æŒç¼©æ”¾
- æ—‹è½¬

[æºç åœ°å€](https://github.com/vangleer/es-drager)

## æ‹–æ‹½&åŒºåŸŸæ‹–æ‹½

[å›¾ç‰‡]

è™½ç„¶å«æ‹–æ‹½ï¼Œä½†å´è·Ÿæ‹–æ‹½äº‹ä»¶æ²¡æœ‰ä¸€ç‚¹å…³ç³»ï¼Œä¸»è¦ä½¿ç”¨mousedownã€mousemoveã€mouseupäº‹ä»¶æ¥å®ç°

### ä»£ç å®ç°

```html
<template>
  <div
    ref="dragRef"
    :class="['es-drager']"
    :style="dragStyle"
    @mousedown="onMousedown"
  >
    <slot />
  </div>
</template>

<script setup lang='ts'>
import { computed, ref } from 'vue'
// å•ä½å¤„ç†
const withUnit = (val: number | string = 0) => {
  return parseInt(val + '') + 'px'
}
const props = defineProps({
  boundary: { // è¾¹ç•Œ
    type: Boolean
  },
  width: {
    type: [Number, String],
    default: 100
  },
  height: {
    type: [Number, String],
    default: 100
  },
  left: {
    type: [Number, String],
    default: 0
  },
  top: {
    type: [Number, String],
    default: 0
  },
  color: {
    type: String,
    default: '#3a7afe'
  }
})
const emit = defineEmits(['move', 'resize'])

// æ‹–æ‹½å…ƒç´ 
const dragRef = ref<HTMLElement | null>(null)
// æ˜¯å¦æŒ‰ä¸‹é¼ æ ‡
const isMousedown = ref(false)
// æ‹–æ‹½æ•°æ®
const dragData = ref({
  width: props.width,
  height: props.height,
  left: props.left,
  top: props.top
})
const dragStyle = computed(() => {
  const { width, height, left, top } = dragData.value
  return {
    width: withUnit(width),
    height: withUnit(height),
    left: withUnit(left),
    top: withUnit(top),
    '--es-drager-color': props.color
  }
})

/**
 * é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
 */
function onMousedown(e: MouseEvent) {
  isMousedown.value = true
  const el = dragRef.value!
  
  // è®°å½•æŒ‰ä¸‹çš„ä½ç½®
  const downX = e.clientX
  const downY = e.clientY

  const elRect = el.getBoundingClientRect()
  // é¼ æ ‡åœ¨ç›’å­é‡Œçš„ä½ç½®
  const mouseX = downX - elRect.left
  const mouseY = downY - elRect.top

  const onMousemove = (e: MouseEvent) => {
    // å½“å‰é¼ æ ‡çš„ä½ç½®å‡å»é¼ æ ‡åœ¨ç›’å­é‡Œçš„ä½ç½®å°±æ˜¯è¦ç§»åŠ¨çš„è·ç¦»
    let moveX = e.clientX - mouseX
    let moveY = e.clientY - mouseY
    
    dragData.value.left = moveX
    dragData.value.top = moveY
    emit && emit('move', dragData.value)
  }

  const onMouseup = (_e: MouseEvent) => {
    isMousedown.value = false
    // ç§»é™¤documentäº‹ä»¶
    document.removeEventListener('mousemove', onMousemove)
    document.removeEventListener('mouseup', onMouseup)
  }
  // ä½documentæ³¨å†Œé¼ æ ‡ç§»åŠ¨äº‹ä»¶
  document.addEventListener('mousemove', onMousemove)
  // é¼ æ ‡æŠ¬èµ·äº‹ä»¶
  document.addEventListener('mouseup', onMouseup)
}
</script>

<style lang='scss'>
.es-drager {
  position: absolute;
  z-index: 1000;
  border: 1px solid var(--es-drager-color, #3a7afe);
}
</style>

```

å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒé€»è¾‘ä¸»è¦åœ¨ onMousedown äº‹ä»¶å¤„ç†å‡½æ•°ä¸­

æ­¥éª¤åˆ†æï¼š

  1. ä¸ºæ‹–æ‹½å…ƒç´ æ³¨å†Œmousedownäº‹ä»¶
  2. é¼ æ ‡æŒ‰ä¸‹è®°å½•å½“å‰é¼ æ ‡çš„ä½ç½®ï¼Œé¼ æ ‡åœ¨å…ƒç´ ä¸­çš„ä½ç½®
  3. ç»™documentæ³¨å†Œmousemoveã€mouseupäº‹ä»¶
  4. mousemoveäº‹ä»¶ä¸­è®¡ç®—å½“å‰å…ƒç´ çš„ä½ç½®
  5. mouseupä¸­ç§»é™¤documentäº‹ä»¶


### æ·»åŠ è¾¹ç•Œ(åŒºåŸŸæ‹–æ‹½)

åŒºåŸŸæ‹–æ‹½ä¸»è¦æ˜¯ä¸ºäº†é™åˆ¶å…ƒç´ åªèƒ½åœ¨æœ€è¿‘å®šä½çˆ¶çº§å…ƒç´ ä¸­ç§»åŠ¨

```typescript
function onMousedown(e: MouseEvent) {
  isMousedown.value = true
  const el = dragRef.value!
  const downX = e.clientX
  const downY = e.clientY
  const elRect = el.getBoundingClientRect()

  // é¼ æ ‡åœ¨ç›’å­é‡Œçš„ä½ç½®
  const mouseX = downX - elRect.left
  const mouseY = downY - elRect.top

  // æå‰è®¡ç®—æœ€å°æœ€å¤§è¾¹ç•Œå€¼
  let minX = 0, maxX = 0, minY = 0, maxY = 0
  if (props.boundary) {
    const parentEl = el.parentElement || document.body
    const parentElRect = parentEl!.getBoundingClientRect()
    // æœ€å°x
    minX = parentElRect.left
    // æœ€å¤§x
    maxX = parentElRect.left + parentElRect.width - elRect.width
    // æœ€å°y
    minY = parentElRect.top
    // æœ€å¤§y
    maxY = parentElRect.top + parentElRect.height - elRect.height
  }

  const onMousemove = (e: MouseEvent) => {
    let moveX = e.clientX - mouseX
    let moveY = e.clientY - mouseY

    if (props.boundary) {
      // åˆ¤æ–­xæœ€å°æœ€å¤§è¾¹ç•Œ
      // moveX = moveX < minX ? minX : moveX > maxX ? maxX : moveX
      moveX = moveX < minX ? minX : moveX
      moveX = moveX > maxX ? maxX : moveX
      
      // åˆ¤æ–­yæœ€å°æœ€å¤§è¾¹ç•Œ
      // moveY = moveY < minY ? minY : moveY > maxY ? maxY : moveY
      moveY = moveY < minY ? minY : moveY
      moveY = moveY > maxY ? maxY : moveY
    }
    
    dragData.value.left = moveX
    dragData.value.top = moveY
    emit && emit('move', dragData.value)
  }

  const onMouseup = (_e: MouseEvent) => {
    isMousedown.value = false
    document.removeEventListener('mousemove', onMousemove)
    document.removeEventListener('mouseup', onMouseup)
  }
  document.addEventListener('mousemove', onMousemove)
  document.addEventListener('mouseup', onMouseup)
}
```

è¾¹ç•Œå€¼è¯´æ˜ï¼š

  1. æœ€å°xï¼Œæœ€è¿‘å®šä½çˆ¶çº§æ ‡ç­¾çš„left
  2. æœ€å¤§xï¼Œæœ€è¿‘å®šä½çˆ¶çº§æ ‡ç­¾çš„left + çˆ¶çº§çš„width - å…ƒç´ çš„width
  3. æœ€å°yï¼Œæœ€è¿‘å®šä½çˆ¶çº§æ ‡ç­¾çš„top
  4. æœ€å¤§yï¼Œæœ€è¿‘å®šä½çˆ¶çº§æ ‡ç­¾çš„top + çˆ¶çº§çš„height - å…ƒç´ çš„height

## ç¼©æ”¾

[å›¾ç‰‡]

å¯ä»¥çœ‹åˆ°å…ƒç´ å‘¨å›´æœ‰8ä¸ªå°åœ†ç‚¹ï¼Œå¯ä»¥ä»ä¸åŒçš„æ–¹å‘æ”¾å¤§æˆ–ç¼©å°å…ƒç´ 

### æ˜¾ç¤ºå°åœ†ç‚¹ï¼Œè®¡ç®—ä½ç½®

```html
<template>
  <div
    ref="dragRef"
    :class="['es-drager']"
    :style="dragStyle"
    @mousedown="onMousedown"
  >
    <slot />

    <div v-show="selected">
      <div
        v-for="item in dotList"
        :key="item.side"
        class="es-drager-dot"
        :data-side="item.side"
        :style="getDotStyle(item)"
        @mousedown="onDotMousedown(item, $event)"
      >
      </div>
    </div>
  </div>
</template>
<script setup lang='ts'>
import { computed, ref } from 'vue'

type IDotSide = 'top' | 'bottom' | 'left' | 'right' | 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right'
type IDot = {
  side: IDotSide,
  cursor?: string
}
const dotList: IDot[] = [
  { side: 'top', cursor: 'n-resize' },
  { side: 'bottom', cursor: 'n-resize' },
  { side: 'left', cursor: 'e-resize' },
  { side: 'right', cursor: 'e-resize' },
  { side: 'top-left', cursor: 'se-resize' },
  { side: 'top-right', cursor: 'sw-resize' },
  { side: 'bottom-left', cursor: 'sw-resize' },
  { side: 'bottom-right', cursor: 'se-resize' }
]
const selected = ref(true)

const emit = defineEmits(['move', 'resize'])

// è®¡ç®—åœ†ç‚¹ä½ç½®
function getDotStyle(item: IDot) {
  const [side, position] = item.side.split('-')
  const style = { [side]: '0%', cursor: item.cursor }
  if (!position) {
    const side2 = ['top', 'bottom'].includes(side) ? 'left' : 'top'
    style[side2] = '50%'
  } else {
    style[position] = '0%'
  }

  return style
}

function onDotMousedown(dotInfo: IDot, e: MouseEvent) {
  e.stopPropagation()
  e.preventDefault()
  // ...
}
</script>
<style lang='scss'>
.es-drager-dot {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: var(--es-drager-color, #3a7afe);
  transform: translate(-50%, -50%);
  cursor: se-resize;
  &[data-side*="right"] {
    transform: translate(50%, -50%);
  }
  &[data-side*="bottom"] {
    transform: translate(-50%, 50%);
  }
  &[data-side="bottom-right"] {
    transform: translate(50%, 50%);
  }
}
</style>
```

- selected é€‰ä¸­æ‹–æ‹½å…ƒç´ æ—¶æ˜¾ç¤ºç¼©æ”¾å°åœ†ç‚¹
- ä¸»è¦å…³æ³¨ç‚¹è¿˜æ˜¯åœ¨å°åœ†ç‚¹çš„æ‹–æ‹½ä¸Šï¼ŒonDotMousedown äº‹ä»¶å¤„ç†å‡½æ•°

```typescript
function onDotMousedown(dotInfo: IDot, e: MouseEvent) {
  e.stopPropagation()
  e.preventDefault()
  // è·å–é¼ æ ‡æŒ‰ä¸‹çš„åæ ‡
  const downX = e.clientX
  const downY = e.clientY
  const el = dragRef.value!
  const elRect = el.getBoundingClientRect()
  
  const onMousemove = (e: MouseEvent) => {
    // ç§»åŠ¨çš„xè·ç¦»
    const disX = e.clientX - downX
    // ç§»åŠ¨çš„yè·ç¦»
    const disY = e.clientY - downY

    const [side, position] = dotInfo.side.split('-')

    // æ˜¯å¦æ˜¯ä¸Šæ–¹ç¼©æ”¾åœ†ç‚¹
    const hasT = side === 'top'
    // æ˜¯å¦æ˜¯å·¦æ–¹ç¼©æ”¾åœ†ç‚¹
    const hasL = [side, position].includes('left')
    
    let width = elRect.width + (hasL ? -disX : disX)
    let height = elRect.height + (hasT ? -disY : disY)
    
    // å¦‚æœæ˜¯å·¦ä¾§ç¼©æ”¾åœ†ç‚¹ï¼Œä¿®æ”¹leftä½ç½®
    let left = elRect.left + (hasL ? disX : 0)

    // å¦‚æœæ˜¯ä¸Šæ–¹ç¼©æ”¾åœ†ç‚¹ï¼Œä¿®æ”¹topä½ç½®
    let top = elRect.top + (hasT ? disY : 0)

    if (!position) { // å¦‚æœæ˜¯å››ä¸ªæ­£æ–¹ä½
      if (['top', 'bottom'].includes(side)) {
        // ä¸Šä¸‹å°±ä¸æ”¹å˜å®½åº¦
        width = elRect.width
      } else {
        // å·¦å³å°±ä¸æ”¹å˜é«˜åº¦
        height = elRect.height
      }
    }

    // å¤„ç†é€†å‘ç¼©æ”¾
    if (width < 0) {
      width = -width
      left -= width
    }
    if (height < 0) {
      height = -height
      top -= height
    }

    dragData.value = { left, top, width, height }
    emit('resize', dragData.value)
  }

  const onMouseup = (_e: MouseEvent) => {
    document.removeEventListener('mousemove', onMousemove)
    document.removeEventListener('mouseup', onMouseup)
  }
  document.addEventListener('mousemove', onMousemove)
  document.addEventListener('mouseup', onMouseup)
}
```

è§£æï¼š

  1. é¼ æ ‡æŒ‰ä¸‹è®°å½•æŒ‰ä¸‹çš„åæ ‡
  2. ç§»åŠ¨æ—¶åˆ†åˆ«è®¡ç®—xå’Œyç§»åŠ¨çš„è·ç¦»
  3. å³æ–¹å’Œä¸‹æ–¹ç¼©æ”¾æ¯”è¾ƒå¥½å®ç°ï¼Œç›´æ¥æ”¹å˜å®½é«˜å°±è¡Œï¼ŒåŸæ¥çš„å®½åº¦+ç§»åŠ¨çš„è·ç¦»
  4. éœ€è¦æ³¨æ„çš„æ˜¯ä¸Šæ–¹å’Œå·¦æ–¹çš„ç¼©æ”¾ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–¹å‘ï¼Œä¸ä»…è¦ä¿®æ”¹å®½é«˜ï¼Œè¿˜éœ€è¦ä¿®æ”¹ä½ç½®
  5. `let width = elRect.width + (hasL ? -disX : disX)` å¦‚æœæ˜¯å·¦ä¾§ç¼©æ”¾åœ†ç‚¹ï¼Œç°åœ¨çš„å®½åº¦å‡å»ç§»åŠ¨çš„xè·ç¦»ã€‚åŒæ—¶ `let left = elRect.left + (hasL ? disX : 0)` leftéœ€è¦åŠ ä¸Šç§»åŠ¨çš„xï¼Œå¯èƒ½è¿™æ ·å†™æ›´å¥½ç†è§£ä¸€ç‚¹

  ```typescript
    let width = elRect.width, left = elRect.left
    if (hasL) {
      width -= disX
      left += disX
    } else {
      width += disX
    }
  ```
  6. å¦‚æœæ˜¯å››ä¸ªæ­£æ–¹å‘ï¼Œä¸Šä¸‹æ— éœ€ä¿®æ”¹å®½åº¦ï¼Œå·¦å³æ— éœ€ä¿®æ”¹é«˜åº¦


## æ—‹è½¬

[å›¾ç‰‡]

åœ¨è®¡ç®—è§’åº¦çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°Mathçš„atan2æ–¹æ³•ï¼Œè¿”å›ä»åŸç‚¹ (0,0) åˆ° (x,y) ç‚¹çš„çº¿æ®µä¸ x è½´æ­£æ–¹å‘ä¹‹é—´çš„å¹³é¢è§’åº¦ (å¼§åº¦å€¼)ï¼Œä¹Ÿå°±æ˜¯ Math.atan2(y,x)

å…³äºæ—‹è½¬æŒ‰é’®çš„æ ·å¼å°±ä¸è´´ä»£ç äº†ï¼Œç›´æ¥ä»mousdownäº‹ä»¶å¼€å§‹å§

```typescript
function onRotateMousedown(e: MouseEvent) {
  e.stopPropagation()
  e.preventDefault()
  const el = dragRef.value!
  const elRect = el.getBoundingClientRect()
  // æ—‹è½¬ä¸­å¿ƒä½ç½®
  const centerX = elRect.left + elRect.width / 2
  const centerY = elRect.top + elRect.height / 2

  function onMousemove(e: MouseEvent) {
    const diffX = centerX - e.clientX
    const diffY = centerY - e.clientY
    // Math.atan2(y,x) è¿”å›ä»åŸç‚¹ (0,0) åˆ° (x,y) ç‚¹çš„çº¿æ®µä¸ x è½´æ­£æ–¹å‘ä¹‹é—´çš„å¹³é¢è§’åº¦ (å¼§åº¦å€¼)
    const radians = Math.atan2(diffY, diffX)

    // è®¡ç®—è§’åº¦
    dragData.value.angle = radians * 180 / Math.PI - 90 // è§’åº¦
    emit('rotate', angle.value)
  }

  const onMouseup = (_e: MouseEvent) => {
    document.removeEventListener('mousemove', onMousemove)
    document.removeEventListener('mouseup', onMouseup)
  }
  document.addEventListener('mousemove', onMousemove)
  document.addEventListener('mouseup', onMouseup)
}
```

1. é¦–å…ˆè¦è®¡ç®—å‡ºæ—‹è½¬ä¸­å¿ƒä½ç½®
2. é¼ æ ‡ç§»åŠ¨è®¡ç®—ç§»åŠ¨çš„ç‚¹å’Œä¸­å¿ƒç‚¹çš„è·ç¦»
3. ä½¿ç”¨Math.atan2è®¡ç®—å¼§åº¦ï¼Œæ³¨æ„ y æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°
4. ä½¿ç”¨å¼§åº¦è®¡ç®—å‡ºè§’åº¦ï¼Œåé¢å‡å»äº†90æ˜¯å› ä¸ºå½“å‰æ—‹è½¬æŒ‰é’®åœ¨æ­£ä¸Šæ–¹ï¼Œè€Œé»˜è®¤è®¡ç®—çš„æ˜¯ä»æ­£å·¦æ–¹å¼€å§‹çš„


## æœ€å

ç»†å¿ƒçš„ä¼™ä¼´å¯èƒ½å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ—‹è½¬åå†ç¼©æ”¾ä¼šå¾ˆå¥‡æ€ªï¼Œè€Œä¸”æ—‹è½¬åé¼ æ ‡ç»è¿‡ç¼©æ”¾åœ†ç‚¹ä¸Šæ—¶çš„æ ·å¼ä¹Ÿä¸ç›¸ç§°ã€‚

ä¸‹æ¬¡å†æ¥è§£å†³è¿™ä¸ªé—®é¢˜å§ï¼
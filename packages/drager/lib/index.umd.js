(function(M,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],r):(M=typeof globalThis<"u"?globalThis:M||self,r(M.ESDrager={},M.Vue))})(this,function(M,r){"use strict";const H={tag:{type:[String,Object],default:"div"},resizable:{type:Boolean,default:!0},rotatable:{type:Boolean,default:!1},boundary:{type:Boolean},disabled:Boolean,width:{type:Number,default:0},height:{type:Number,default:0},left:{type:Number,default:0},top:{type:Number,default:0},zIndex:{type:Number,default:0},angle:{type:Number,default:0},color:{type:String,default:"#3a7afe"},minWidth:{type:Number,default:-1/0},minHeight:{type:Number,default:-1/0},aspectRatio:{type:Number},selected:Boolean,snapToGrid:Boolean,gridX:{type:Number,default:50},gridY:{type:Number,default:50},scaleRatio:{type:Number,default:1},disabledKeyEvent:Boolean,border:{type:Boolean,default:!0},resizeList:{type:Array}};function C(a,n){const e=t=>{n&&n(t),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e),document.removeEventListener("mouseleave",e),document.removeEventListener("touchmove",a),document.removeEventListener("touchend",e)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",e),document.addEventListener("mouseleave",e),document.addEventListener("touchmove",a),document.addEventListener("touchend",e)}function Y(a){let n=0,e=0;if(W(a)){const t=a.targetTouches[0];n=t.pageX,e=t.pageY}else n=a.clientX,e=a.clientY;return{clientX:n,clientY:e}}function W(a){const n=Object.prototype.toString.call(a);return n.substring(8,n.length-1)==="TouchEvent"}const z=(a=0)=>parseInt(a+"")+"px",x={n:"top",s:"bottom",e:"right",w:"left",ne:"top-right",nw:"top-left",se:"bottom-right",sw:"bottom-left"},$=["n","ne","e","se","s","sw","w","nw"],ee={n:0,ne:1,e:2,se:3,s:4,sw:5,w:6,nw:7},te={0:0,1:1,2:2,3:2,4:3,5:4,6:4,7:5,8:6,9:6,10:7,11:8},ne=(a,n)=>{const e=te[Math.floor(a/30)],c=(ee[n]+e)%8;return $[c]},K=(a=0,n)=>{let e=[];for(let t=0;t<$.length;t++){const c=$[t],[h,d]=x[c].split("-"),f=ne(a,c),u={[h]:"0%",cursor:f+"-resize",side:x[c]};if(d)u[d]="0%";else{const m=["top","bottom"].includes(h)?"left":"top";u[m]="50%"}n?n.includes(x[c])&&e.push(u):e.push(u)}return e},I=a=>a*Math.PI/180,oe=(a,n)=>Math.sqrt(a*a+n*n),w=a=>Math.cos(I(a)),y=a=>Math.sin(I(a)),se=(a,n,e,t,c,h,d)=>{let{width:f,height:u,centerX:m,centerY:p,rotateAngle:o}=n;const g=f<0?-1:1,i=u<0?-1:1;switch(f=Math.abs(f),u=Math.abs(u),a){case"right":{const s=X(f,e,h);f=s.width,e=s.deltaW,c?(t=e/c,u=f/c,m+=e/2*w(o)-t/2*y(o),p+=e/2*y(o)+t/2*w(o)):(m+=e/2*w(o),p+=e/2*y(o));break}case"top-right":{t=-t;const s=X(f,e,h);f=s.width,e=s.deltaW;const l=L(u,t,d);u=l.height,t=l.deltaH,c&&(e=t*c,f=u*c),m+=e/2*w(o)+t/2*y(o),p+=e/2*y(o)-t/2*w(o);break}case"bottom-right":{const s=X(f,e,h);f=s.width,e=s.deltaW;const l=L(u,t,d);u=l.height,t=l.deltaH,c&&(e=t*c,f=u*c),m+=e/2*w(o)-t/2*y(o),p+=e/2*y(o)+t/2*w(o);break}case"bottom":{const s=L(u,t,d);u=s.height,t=s.deltaH,c?(e=t*c,f=u*c,m+=e/2*w(o)-t/2*y(o),p+=e/2*y(o)+t/2*w(o)):(m-=t/2*y(o),p+=t/2*w(o));break}case"bottom-left":{e=-e;const s=X(f,e,h);f=s.width,e=s.deltaW;const l=L(u,t,d);u=l.height,t=l.deltaH,c&&(u=f/c,t=e/c),m-=e/2*w(o)+t/2*y(o),p-=e/2*y(o)-t/2*w(o);break}case"left":{e=-e;const s=X(f,e,h);f=s.width,e=s.deltaW,c?(u=f/c,t=e/c,m-=e/2*w(o)+t/2*y(o),p-=e/2*y(o)-t/2*w(o)):(m-=e/2*w(o),p-=e/2*y(o));break}case"top-left":{e=-e,t=-t;const s=X(f,e,h);f=s.width,e=s.deltaW;const l=L(u,t,d);u=l.height,t=l.deltaH,c&&(f=u*c,e=t*c),m-=e/2*w(o)-t/2*y(o),p-=e/2*y(o)+t/2*w(o);break}case"top":{t=-t;const s=L(u,t,d);u=s.height,t=s.deltaH,c?(f=u*c,e=t*c,m+=e/2*w(o)+t/2*y(o),p+=e/2*y(o)-t/2*w(o)):(m+=t/2*y(o),p-=t/2*w(o));break}}return{position:{centerX:m,centerY:p},size:{width:f*g,height:u*i}}},L=(a,n,e)=>{const t=a+n;return t>e?a=t:(n=e-a,a=e),{height:a,deltaH:n}},X=(a,n,e)=>{const t=a+n;return t>e?a=t:(n=e-a,a=e),{width:a,deltaW:n}},re=({centerX:a,centerY:n,width:e,height:t,angle:c})=>({top:n-t/2,left:a-e/2,width:e,height:t,angle:c}),ae=(a,n,e)=>{const{width:t,height:c}=a;return{width:Math.abs(t),height:Math.abs(c),left:n-Math.abs(t)/2,top:e-Math.abs(c)/2}};function R(a,n){const e=Math.abs(a)%n,t=a>0?n:-n;let c=0;return e>n/2?c=t*Math.ceil(Math.abs(a)/n):c=t*Math.floor(Math.abs(a)/n),c}function ce(a,n,e){const t=r.ref(!1),c=r.ref(!1),h=r.ref({width:n.width,height:n.height,left:n.left,top:n.top,angle:n.angle});function d(o){if(n.disabled)return;t.value=!0,c.value=!0;let{clientX:g,clientY:i}=Y(o);const{left:s,top:l}=h.value;let b=0,v=0;n.boundary&&([b,v]=f()),e&&e("drag-start",h.value),C(D=>{const{clientX:_,clientY:P}=Y(D);let A=(_-g)/n.scaleRatio+s,B=(P-i)/n.scaleRatio+l;if(n.snapToGrid){let{left:S,top:E}=h.value;const G=A-S,j=B-E;A=S+R(G,n.gridX),B=E+R(j,n.gridY)}n.boundary&&([A,B]=u(A,B,b,v)),h.value.left=A,h.value.top=B,e&&e("drag",h.value)},D=>{t.value=!1,document.addEventListener("click",m,{once:!0}),e&&e("drag-end",h.value)})}const f=()=>{const{width:o,height:g}=h.value,s=(a.value.parentElement||document.body).getBoundingClientRect(),l=s.width/n.scaleRatio-o,b=s.height/n.scaleRatio-g;return[l,b]},u=(o,g,i,s)=>(o=o<0?0:o,o=o>i?i:o,g=g<0?0:g,g=g>s?s:g,[o,g]),m=()=>{c.value=!1},p=o=>{if(t.value)return;let{left:g,top:i}=h.value;if(["ArrowRight","ArrowLeft"].includes(o.key)){const s=o.key==="ArrowRight";let l=s?1:-1;n.snapToGrid&&(l=s?n.gridX:-n.gridX),g=g+l}else if(["ArrowUp","ArrowDown"].includes(o.key)){const s=o.key==="ArrowDown";let l=s?1:-1;n.snapToGrid&&(l=s?n.gridY:-n.gridY),i=i+l}if(n.boundary){const[s,l]=f();[g,i]=u(g,i,s,l)}h.value.left=g,h.value.top=i};return r.onMounted(()=>{if(!a.value)return;const{width:o,height:g}=a.value.getBoundingClientRect();console.log(o,g,"width, height"),h.value={...h.value,width:o||100,height:g||100},a.value.addEventListener("mousedown",d),a.value.addEventListener("touchstart",d)}),r.watch(c,o=>{n.disabledKeyEvent||(o?document.addEventListener("keydown",p):document.removeEventListener("keydown",p))}),r.onBeforeUnmount(()=>{document.removeEventListener("keydown",p)}),{isMousedown:t,selected:c,dragData:h}}const ie=r.createElementVNode("div",{class:"es-drager-rotate-handle"},[r.createElementVNode("svg",{viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg"},[r.createElementVNode("path",{fill:"currentColor",d:"M784.512 230.272v-50.56a32 32 0 1 1 64 0v149.056a32 32 0 0 1-32 32H667.52a32 32 0 1 1 0-64h92.992A320 320 0 1 0 524.8 833.152a320 320 0 0 0 320-320h64a384 384 0 0 1-384 384 384 384 0 0 1-384-384 384 384 0 0 1 643.712-282.88z"})])],-1),le=r.defineComponent({__name:"rotate",props:{modelValue:{type:Number,default:0},element:{type:Object,required:!0}},emits:["update:modelValue","rotate","rotate-start","rotate-end"],setup(a,{emit:n}){const e=a,t=r.ref(null),c=r.computed({get:()=>e.modelValue,set:d=>{n("update:modelValue",d)}});function h(d){if(!e.element)return console.warn("[es-drager] rotate component need drag element property");d.stopPropagation(),d.preventDefault();const{width:f,height:u,left:m,top:p}=e.element.getBoundingClientRect(),o=m+f/2,g=p+u/2;n("rotate-start",c.value),C(i=>{const{clientX:s,clientY:l}=Y(i),b=o-s,v=g-l,D=Math.atan2(v,b)*180/Math.PI-90;c.value=(D+360)%360,n("rotate",c.value)},()=>{n("rotate-end",c.value)})}return(d,f)=>(r.openBlock(),r.createElementBlock("div",{ref_key:"rotateRef",ref:t,class:"es-drager-rotate",onMousedown:h,onTouchstart:h},[r.renderSlot(d.$slots,"default",{},()=>[ie])],544))}}),De="",de=["data-side","onMousedown","onTouchstart"],ue=r.createElementVNode("div",{class:"es-drager-dot-handle"},null,-1),fe=r.createElementVNode("div",{class:"es-drager-mask"},null,-1),N=r.defineComponent({__name:"drager",props:H,emits:["change","drag","drag-start","drag-end","resize","resize-start","resize-end","rotate","rotate-start","rotate-end"],setup(a,{emit:n}){const e=a,t=(i,...s)=>{n(i,...s),n("change",...s)},c=r.ref(null),{selected:h,dragData:d,isMousedown:f}=ce(c,e,t),u=r.ref(K(0,e.resizeList)),m=r.computed(()=>{const{width:i,height:s,left:l,top:b,angle:v}=d.value,k={};return i&&(k.width=z(i)),s&&(k.height=z(s)),{...k,left:z(l),top:z(b),zIndex:e.zIndex,transform:`rotate(${v}deg)`,"--es-drager-color":e.color}});function p(i){c.value||(c.value=i.$el||i)}function o(i){u.value=K(i,e.resizeList),t("rotate-end",d.value)}function g(i,s){s.stopPropagation(),s.preventDefault();const{clientX:l,clientY:b}=Y(s),v=l,k=b,{width:D,height:_,left:P,top:A}=d.value,B=P+D/2,S=A+_/2,E={width:D,height:_,centerX:B,centerY:S,rotateAngle:d.value.angle},G=i.side,{minWidth:j,minHeight:he,aspectRatio:F}=e;t("resize-start",d.value),C(U=>{const{clientX:ge,clientY:me}=Y(U);let T=(ge-v)/e.scaleRatio,V=(me-k)/e.scaleRatio;e.snapToGrid&&(T=R(T,e.gridX),V=R(V,e.gridY));const pe=Math.atan2(V,T),q=oe(T,V),we=U.shiftKey,J=pe-I(E.rotateAngle),ye=q*Math.cos(J),be=q*Math.sin(J),ve=we&&!F?E.width/E.height:F,{position:{centerX:Q,centerY:Z},size:{width:Me,height:Ee}}=se(G,{...E,rotateAngle:E.rotateAngle},ye,be,ve,j,he),ke=re({centerX:Q,centerY:Z,width:Me,height:Ee,angle:d.value.angle});d.value={...d.value,...ae(ke,Q,Z)},t("resize",d.value)},()=>{t("resize-end",d.value)})}return r.watch(()=>[e.width,e.height,e.left,e.top,e.angle],([i,s,l,b,v])=>{d.value={...d.value,width:i,height:s,left:l,top:b,angle:v}}),r.watch(()=>e.selected,i=>{h.value=i},{immediate:!0}),(i,s)=>(r.openBlock(),r.createBlock(r.resolveDynamicComponent(i.tag),{ref:p,class:r.normalizeClass(["es-drager",{disabled:i.disabled,dragging:r.unref(f),selected:r.unref(h),border:i.border}]),style:r.normalizeStyle(r.unref(m)),onClick:s[3]||(s[3]=r.withModifiers(()=>{},["stop"]))},{default:r.withCtx(()=>[r.renderSlot(i.$slots,"default"),!i.disabled&&i.resizable?(r.openBlock(!0),r.createElementBlock(r.Fragment,{key:0},r.renderList(u.value,(l,b)=>(r.openBlock(),r.createElementBlock("div",{key:b,class:"es-drager-dot","data-side":l.side,style:r.normalizeStyle({...l}),onMousedown:r.withModifiers(v=>g(l,v),["stop","prevent"]),onTouchstart:v=>g(l,v)},[r.renderSlot(i.$slots,"resize",r.normalizeProps(r.guardReactiveProps({side:l.side})),()=>[ue])],44,de))),128)):r.createCommentVNode("",!0),!i.disabled&&r.unref(h)?(r.openBlock(),r.createBlock(le,{key:1,modelValue:r.unref(d).angle,"onUpdate:modelValue":s[0]||(s[0]=l=>r.unref(d).angle=l),"drag-data":r.unref(d),element:c.value,onRotate:s[1]||(s[1]=l=>t("rotate",r.unref(d))),onRotateStart:s[2]||(s[2]=l=>t("rotate-start",r.unref(d))),onRotateEnd:o},{default:r.withCtx(()=>[r.renderSlot(i.$slots,"rotate")]),_:3},8,["modelValue","drag-data","element"])):r.createCommentVNode("",!0),fe]),_:3},8,["class","style"]))}}),Ae="",O=a=>{a.component("es-drager",N)};N.install=O,M.ESDrager=N,M.default=N,M.install=O,Object.defineProperties(M,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

import{d as M,r as w,eC as q,eJ as L,eA as X,eD as re,g as ae,eK as ue,o as y,c as C,F as Y,a as j,t as G,eL as ie,eM as P,eI as $,_ as Q,i as x,eN as F,b as O,w as k,eF as ce,m as R,e as I,u as D,eG as de,eH as pe,eO as fe,eP as U,eQ as me,eR as ve,eS as ge,f as T,eT as he}from"./index-bc805ebc.js";import{i as _e}from"./index.es-0e3fd31e.js";import{M as ye,c as xe,e as b,d as J}from"./common-808e5d48.js";import{G as be}from"./GridRect-7c1a5d69.js";import{A as we}from"./Area-46d6fcad.js";const Ce={key:0},Ee=["onClick"],ke=M({__name:"Dropdown",props:{option:{type:Object,default:()=>({})}},setup(c,{expose:t}){const l=c,d=w(),e=q({option:l.option,visible:!1,top:0,left:0}),a=L(()=>({left:e.left+"px",top:e.top+"px"})),v=m=>{e.option=m;const{top:_,left:E,height:A}=m.el.getBoundingClientRect();e.top=_+A,e.left=E,e.visible=!0},p=()=>{e.visible=!1},r=m=>{l.option.onClick&&l.option.onClick(m),p()};function u(m){d.value.contains(m.target)||p()}return X(()=>{document.addEventListener("mousedown",u,!0)}),re(()=>{document.removeEventListener("mousedown",u)}),t({open:v,close:p}),(m,_)=>ae((y(),C("div",{ref_key:"menuRef",ref:d,class:"es-contentmenu",style:P(a.value),onClick:_[0]||(_[0]=$(()=>{},["stop"]))},[e.option.items?(y(),C("ul",Ce,[(y(!0),C(Y,null,j(e.option.items,E=>(y(),C("li",{onClick:A=>r(E)},G(E.label),9,Ee))),256))])):ie("",!0)],4)),[[ue,e.visible]])}});const De=Q(ke,[["__scopeId","data-v-889481eb"]]);let V=null;function Me(c){const t=document.createElement("div");if(!V){V=x(De,{option:c});const d=F(V,t);console.log(d,t.firstElementChild,"containercontainer"),document.body.appendChild(t.firstElementChild)}const{open:l}=V.component.exposed;l(c)}const Ae=M({__name:"index",props:{modelValue:{type:Object,required:!0,default:()=>({})},commands:{type:Object}},setup(c){const t=c,l=L({get(){return t.modelValue},set(){}}),d=L(()=>t.modelValue.container.gridSize||10),e=L(()=>({"--es-editor-grid-size":d.value+"px",transformOrigin:"left top"})),a=w(!1),v=w({startX:0,startY:0,disX:0,disY:0}),p=w(),r=q({left:null,top:null}),u=w({x:[],y:[]});function m(n){a.value||l.value.elements.forEach(s=>s.selected=!1);const o=l.value.elements[n];o.selected=!0,v.value.startX=o.left,v.value.startY=o.top,p.value=n,u.value=xe(l.value.elements,p.value),b.emit("dragstart")}function _(){b.emit("dragend"),r.left=null,r.top=null}function E(n){const o=n.left-v.value.startX,s=n.top-v.value.startY;r.top=null,r.left=null;for(let i=0;i<u.value.y.length;i++){const{top:f,showTop:g}=u.value.y[i];if(Math.abs(f-n.top)<5){r.top=g;break}}for(let i=0;i<u.value.x.length;i++){const{left:f,showLeft:g}=u.value.x[i];if(Math.abs(f-n.left)<5){r.left=g;break}}l.value.elements.forEach((i,f)=>{i.selected&&p.value!==f&&(i.left+=o,i.top+=s)}),v.value.startX=n.left,v.value.startY=n.top}function A(n,o){Object.keys(n).forEach(s=>{o[s]=n[s]})}function K(n,o){let s=J(o);console.log(s),n.preventDefault(),Me({el:n.target,items:[{label:"置顶"},{label:"置底"},{label:o.group?"取消组合":"组合"}],onClick:i=>{i.label==="组合"?ee():i.label==="取消组合"&&(console.log("取消组合",s),l.value.elements=te(l.value.elements))}})}const z=w();function H(n){let o=!1;l.value.elements.forEach(s=>{s.selected&&(s.selected=!1,o=!0)}),o||z.value.onMouseDown(n)}function W(n){for(let o=0;o<l.value.elements.length;o++){const s=l.value.elements[o],i=n.left<s.left&&n.left+n.width>s.left+s.width,f=n.top<s.top&&n.top+n.height>s.top+s.height;i&&f?s.selected=!0:s.selected=!1}}function Z(){a.value=l.value.elements.some(n=>n.selected),a.value&&setTimeout(()=>{document.addEventListener("click",()=>{a.value=!1},{once:!0})})}function ee(){const n=l.value.elements.filter(h=>h.selected);if(!n.length)return;let{left:o,top:s}=n[0],i=o,f=s;Math.max(...n.map(h=>h.left)),n.slice(1).forEach(h=>{const{left:B,top:N,width:se,height:le}=h;o=Math.min(o,B),i=Math.max(i,B+se),s=Math.min(s,N),f=Math.max(f,N+le)}),n.forEach(h=>{h.left=h.left-o,h.top=h.top-s});const g={left:o,top:s,width:i-o,height:f-s},ne={component:"es-group",group:!0,...g,props:{elements:n,data:g}},oe=l.value.elements.filter(h=>!h.selected);l.value.elements=[...oe,ne]}function te(n){const o=n.find(g=>g.component==="es-group"),i=o.props.elements.map(g=>({...g,left:g.left+o.left,top:g.top+o.top,angle:g.angle+o.angle}));return[...n.filter(g=>g.component!==o.component),...i]}return(n,o)=>(y(),C("div",{class:"es-editor",style:P(e.value),onMousedown:H},[(y(!0),C(Y,null,j(l.value.elements,(s,i)=>(y(),O(D(_e),R(s,{"grid-x":d.value,"grid-y":d.value,boundary:"",onDragStart:f=>m(i),onDragEnd:_,onDrag:o[0]||(o[0]=f=>E(f)),onChange:f=>A(f,s),onContextmenu:f=>K(f,s),onMousedown:o[1]||(o[1]=$(()=>{},["stop"])),onClick:o[2]||(o[2]=$(()=>{},["stop"]))}),{default:k(()=>[(y(),O(ce(s.component),R(s.props,{style:{...s.style,width:"100%",height:"100%"}}),{default:k(()=>[I(G(s.text),1)]),_:2},1040,["style"]))]),_:2},1040,["grid-x","grid-y","onDragStart","onChange","onContextmenu"]))),256)),x(ye,de(pe(r)),null,16),x(be),x(we,{ref_key:"areaRef",ref:z,onMove:W,onUp:Z},null,512)],36))}});const Ve=Q(Ae,[["__scopeId","data-v-bbbe2132"]]);function Se(c){const t={current:-1,queue:[],commands:{},commandArray:[],destoryArray:[]},l=e=>{t.commandArray.push(e),t.commands[e.name]=(...a)=>{const{redo:v,undo:p}=e.execute(...a);if(v(),e.pushQueue){let{queue:r}=t;r.length>0&&(r=r.slice(0,t.current+1),t.queue=r),t.queue.push({redo:v,undo:p}),t.current+=1}}};l({name:"redo",keyboard:"ctrl+y",execute(){return{redo(){let e=t.queue[t.current+1];e&&(e.redo&&e.redo(),t.current++)}}}}),l({name:"undo",keyboard:"ctrl+z",execute(){return{redo(){if(t.current===-1)return;let e=t.queue[t.current];e&&(e.undo&&e.undo(),t.current--)}}}}),l({name:"drag",pushQueue:!0,init(){const e=()=>{this.before=J(c.value.elements)},a=()=>t.commands.drag();return b.on("dragstart",e),b.on("dragend",a),()=>{b.off("dragstart",e),b.off("dragend",a)}},execute(){const e=this.before,a=c.value.elements;return{redo(){c.value={...c.value,elements:a}},undo(){c.value={...c.value,elements:e}}}}}),l({name:"updateContainer",pushQueue:!0,execute(e){const a={before:c.value,after:e};return{redo(){c.value=a.after},undo(){c.value=a.before}}}}),t.commandArray.forEach(e=>{e.init&&t.destoryArray.push(e.init())});const d=()=>{const e=a=>{const{ctrlKey:v,key:p}=a,r=[];v&&r.push("ctrl"),r.push(p);const u=r.join("+");t.commandArray.forEach(({name:m,keyboard:_})=>{_&&_===u&&(t.commands[m](),a.preventDefault())})};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}};return X(()=>{t.destoryArray.push(d())}),fe(()=>{t.destoryArray.forEach(e=>e&&e())}),t}const Le=M({__name:"Dialog",props:{option:{type:Object,default:()=>({})}},setup(c,{expose:t}){const d=q({option:c.option,visible:!1}),e=p=>{d.option=p,d.visible=!0},a=()=>{d.visible=!1},v=()=>{const{confirm:p}=d.option;p&&p(d.option.content)};return t({open:e,close:a}),(p,r)=>(y(),O(D(ve),R({modelValue:d.visible,"onUpdate:modelValue":r[1]||(r[1]=u=>d.visible=u)},d.option,{draggable:""}),{footer:k(()=>[x(D(U),{onClick:a},{default:k(()=>[I("取消")]),_:1}),x(D(U),{type:"primary",onClick:v},{default:k(()=>[I("确定")]),_:1})]),default:k(()=>[x(D(me),{modelValue:d.option.content,"onUpdate:modelValue":r[0]||(r[0]=u=>d.option.content=u),type:"textarea",rows:10},null,8,["modelValue"])]),_:1},16,["modelValue"]))}});let S=null;function $e(c){const t=document.createElement("div");S||(S=x(Le,{option:c}),F(S,t),document.body.appendChild(t.firstElementChild));const{open:l}=S.component.exposed;l(c)}const Oe={class:"es-layout"},Re={class:"es-layout-container"},Ie={ref:"mainRef",class:"es-layout-main"},Te=T("div",{class:"es-layout-info"},null,-1),qe="ES Drager Editor 开发中...",ze=M({__name:"index",setup(c){const t=w({container:{gridSize:10,style:{width:"500px",height:"500px"}},elements:[{component:"div",width:100,height:100,left:100,top:100,text:"div1",style:{border:"1px solid red"}},{component:"div",width:100,height:100,left:300,top:150,text:"div2",style:{border:"1px solid red"}}]}),{commands:l}=Se(t),d=[{label:"撤销",handler:l.undo},{label:"重做",handler:l.redo},{label:"导出",handler:()=>{$e({title:"导出",content:JSON.stringify(t.value),confirm(u){l.updateContainer(JSON.parse(u))}})}},{label:"导入",handler:()=>console.log("导入")}];let e=null;function a(u){b.emit("dragstart"),e=u}function v(){b.emit("dragend")}function p(u){u.dataTransfer.dropEffect="move"}function r(u){if(!e)return;const m=[...t.value.elements,{...e,left:u.offsetX-e.width/2,top:u.offsetY-e.height/2}];t.value.elements=m,e=null}return(u,m)=>(y(),C("div",Oe,[x(ge,{title:qe,tools:d}),T("div",Re,[x(he,{onDragstart:a,onDragend:v}),T("div",Ie,[x(Ve,{modelValue:t.value,"onUpdate:modelValue":m[0]||(m[0]=_=>t.value=_),commands:D(l),onDragenter:p,onDrop:r,onDragover:m[1]||(m[1]=$(()=>{},["prevent"]))},null,8,["modelValue","commands"])],512),Te])]))}});const je=M({__name:"index",setup(c){return(t,l)=>(y(),O(ze))}});export{je as default};
